
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalización de Interfaz | RSI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        /* Estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            /* Fallbacks por defecto */
            --primary-color: #6C43E0;
            --secondary-color: #5a35c7;
            --accent-color: #8B5FEB;
            --background-color: #f5f5f5;
            --text-color: #333;
            --card-bg: white;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --success-color: #28a745;
            --error-color: #dc3545;
            /* LOGO RSI POR DEFECTO (AJUSTA ESTA URL) */
            --default-bg-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSI5MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmaWxsPSIjRkZGRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj5SU0k8L3RleHQ+PC9zdmc+');
            /* Reemplaza el valor de 'url(...)' anterior por la ruta a tu logo de RSI */
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            
            /* Estilos de fondo por defecto (serán aplicados por JS) */
            background-repeat: no-repeat; 
            background-position: center center; 
            background-size: 50vmax; 
            background-attachment: fixed;
            background-blend-mode: hard-light; 
        }

        /* Clase para cuando hay imagen de fondo (CUBRE TODA LA PANTALLA) */
        body.has-custom-background {
            background-image: var(--current-bg-image);
            background-size: contain; 
            background-color: var(--background-color) !important; 
            background-blend-mode: luminosity; 
            background-repeat: no-repeat;
            background-position: center center;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { margin-bottom: 10px; color: var(--primary-color); }
        .description { color: var(--text-color); opacity: 0.8; margin-bottom: 20px; }
        
        /* Estilos de secciones (mantener) */
        .personalization-section, .preview-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            border: 2px solid var(--primary-color);
        }
        .section-title { font-size: 1.3rem; margin-bottom: 20px; color: var(--primary-color); display: flex; align-items: center; }
        .section-title i { margin-right: 10px; }
        
        /* Opciones de color (mantener) */
        .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .color-option { position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; transition: all 0.3s ease; border: 2px solid transparent; }
        .color-option:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border: 2px solid var(--accent-color); }
        .color-option.selected { transform: scale(1.05); box-shadow: 0 0 0 5px var(--primary-color); border: 3px solid var(--primary-color); }
        .color-preview { height: 80px; width: 100%; }
        .color-name { padding: 10px; text-align: center; font-weight: 500; background-color: var(--card-bg); color: var(--text-color); }
        .checkmark { position: absolute; top: 10px; right: 10px; background-color: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease; }
        .color-option.selected .checkmark { opacity: 1; }

        /* Estilos para carga de imagen de fondo (miniatura en el cuadro de carga) */
        .image-upload-container {
            border: 2px dashed var(--accent-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: var(--card-bg);
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .image-preview-thumbnail {
            max-width: 150px;
            max-height: 100px;
            width: auto;
            height: auto;
            border-radius: 6px;
            border: 2px solid var(--accent-color);
            object-fit: contain;
            margin-top: 10px;
        }
        
        /* Botones (mantener) */
        .buttons-container { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 25px; border: 2px solid transparent; border-radius: 8px; font-size: 1rem; font-weight: 700; letter-spacing: 0.5px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .btn i { margin-right: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--secondary-color); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .btn-primary:hover { background-color: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 4px 8px var(--primary-color)50; }
        .btn-secondary { background-color: var(--card-bg); color: var(--text-color); border-color: var(--accent-color); }
        .btn-secondary:hover { background-color: var(--accent-color)20; transform: translateY(-2px); }
        
        /* Vista previa (mantener) */
        .preview-item { border: 2px solid var(--primary-color); font-weight: 600; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); padding: 12px 20px; border-radius: 8px; font-weight: 600; }
        
        /* Media Queries (mantener) */
        @media (max-width: 768px) {
            .options-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
            .preview-container { flex-direction: column; align-items: center; }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-palette"></i> Personalización de Interfaz</h1>
            <p class="description">Selecciona tus colores y fondos preferidos para personalizar la apariencia de la aplicación.</p>
        </header>
        
        <div id="message" class="message"></div>
        
        <section class="personalization-section">
            <h2 class="section-title"><i class="fas fa-fill-drip"></i> Color de Fondo</h2>
            <div class="options-grid" id="background-options">
                </div>
        </section>
        
        <section class="personalization-section">
            <h2 class="section-title"><i class="fas fa-paint-brush"></i> Combinación de Colores</h2>
            <div class="options-grid" id="theme-options">
                </div>
        </section>

        <section class="personalization-section">
            <h2 class="section-title"><i class="fas fa-image"></i> Logo/Fondo de Pantalla</h2>
            <p class="description">Sube una imagen para reemplazar el logo de RSI en el fondo de la pantalla (solo se aceptan archivos **PNG**).</p>
            
            <div class="image-upload-container" id="upload-box">
                <i class="fas fa-upload"></i>
                <p id="upload-text">Haz clic o arrastra para cambiar el logo</p>
                <input type="file" id="background-file" accept="image/png" style="display: none;">
                <img id="background-preview" class="image-preview-thumbnail" style="display: none;">
            </div>
            
            <div class="buttons-container" style="justify-content: space-around; margin-top: 15px;">
                <button class="btn btn-secondary" id="remove-bg-btn" style="display: none;">
                    <i class="fas fa-trash"></i> Restaurar Logo RSI
                </button>
            </div>
        </section>
        
        <section class="preview-section">
            <h3 class="preview-title">Vista Previa</h3>
            <div class="preview-container">
                <div class="preview-item" id="preview-primary">Botón Principal</div>
                <div class="preview-item" id="preview-secondary">Botón Secundario</div>
                <div class="preview-item" id="preview-accent">Elemento Destacado</div>
            </div>
        </section>
        
        <div class="buttons-container">
            <button class="btn btn-secondary" id="reset-btn">
                <i class="fas fa-undo"></i> Restablecer
            </button>
            <button class="btn btn-primary" id="save-btn">
                <i class="fas fa-save"></i> Guardar Preferencias
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
            authDomain: "rsienterprise.firebaseapp.com",
            projectId: "rsienterprise",
            storageBucket: "rsienterprise.appspot.com",
            messagingSenderId: "1063117165770",
            appId: "1:1063117165770:web:8555f26b25ae80bc42d033"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Estado de la personalización
        const personalizationState = {
            currentUser: null,
            userData: null,
            preferences: {
                background: 'dark', 
                theme: 'purple',
                backgroundImage: null 
            }
        };
        
        // Opciones de personalización
        const backgroundOptions = [
            { id: 'light', name: 'Claro', color: '#f5f5f5', textColor: '#333', cardBg: '#ffffff' },
            { id: 'dark', name: 'Oscuro', color: '#1a1a1a', textColor: '#f5f5f5', cardBg: '#2d2d2d' },
            { id: 'gray', name: 'Gris', color: '#808080', textColor: '#ffffff', cardBg: '#a0a0a0' }
        ];
        
        const themeOptions = [
            { id: 'purple', name: 'Púrpura', primary: '#6C43E0', secondary: '#5a35c7', accent: '#8B5FEB' },
            { id: 'blue', name: 'Azul', primary: '#2196F3', secondary: '#1976D2', accent: '#42A5F5' },
            { id: 'green', name: 'Verde', primary: '#4CAF50', secondary: '#388E3C', accent: '#66BB6A' },
            { id: 'orange', name: 'Naranja', primary: '#FF9800', secondary: '#F57C00', accent: '#FFB74D' },
            { id: 'red', name: 'Rojo', primary: '#F44336', secondary: '#D32F2F', accent: '#EF5350' },
            { id: 'teal', name: 'Verde Azulado', primary: '#009688', secondary: '#00796B', accent: '#26A69A' }
        ];
        
        // Inicializar la interfaz
        document.addEventListener('DOMContentLoaded', function() {
            initPersonalizationInterface();
            setupEventListeners();
            
            // Verificar autenticación
            auth.onAuthStateChanged((user) => {
                if (user) {
                    personalizationState.currentUser = user;
                    loadUserProfile();
                } else {
                    console.log('No hay usuario autenticado');
                }
            });
        });

        // --- FUNCIONES DE MANEJO DE IMAGENES ---
        function fileToBase64(file) {
            // Validación extra para asegurar que el archivo sea PNG (aunque el input ya lo hace)
            if (file && file.type !== 'image/png') {
                Swal.fire({
                    title: 'Formato Inválido',
                    text: 'Solo se permiten archivos de imagen en formato PNG.',
                    icon: 'warning',
                    confirmButtonColor: themeOptions.find(t => t.id === personalizationState.preferences.theme).primary
                });
                return Promise.reject(new Error("Formato de archivo no permitido. Solo PNG."));
            }
            
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Inicializar la interfaz de personalización (mantiene la lógica de carga de opciones)
        function initPersonalizationInterface() {
            const backgroundOptionsContainer = document.getElementById('background-options');
            backgroundOptionsContainer.innerHTML = '';
            backgroundOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'color-option';
                optionElement.dataset.id = option.id;
                optionElement.innerHTML = `
                    <div class="color-preview" style="background-color: ${option.color};"></div>
                    <div class="color-name">${option.name}</div>
                    <div class="checkmark"><i class="fas fa-check"></i></div>
                `;
                backgroundOptionsContainer.appendChild(optionElement);
            });
            
            const themeOptionsContainer = document.getElementById('theme-options');
            themeOptionsContainer.innerHTML = '';
            themeOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'color-option';
                optionElement.dataset.id = option.id;
                optionElement.innerHTML = `
                    <div class="color-preview" style="background: linear-gradient(135deg, ${option.primary} 0%, ${option.accent} 100%);"></div>
                    <div class="color-name">${option.name}</div>
                    <div class="checkmark"><i class="fas fa-check"></i></div>
                `;
                themeOptionsContainer.appendChild(optionElement);
            });
            
            loadSavedPreferences();
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Event Listeners para opciones de color (mantener)
            document.getElementById('background-options').addEventListener('click', function(e) {
                const option = e.target.closest('.color-option');
                if (option) {
                    document.querySelectorAll('#background-options .color-option').forEach(el => el.classList.remove('selected'));
                    option.classList.add('selected');
                    personalizationState.preferences.background = option.dataset.id;
                    applyBackground(); 
                    updatePreview();
                    showSelectionFeedback('Fondo', option.querySelector('.color-name').textContent);
                }
            });
            
            document.getElementById('theme-options').addEventListener('click', function(e) {
                const option = e.target.closest('.color-option');
                if (option) {
                    document.querySelectorAll('#theme-options .color-option').forEach(el => el.classList.remove('selected'));
                    option.classList.add('selected');
                    personalizationState.preferences.theme = option.dataset.id;
                    applyTheme();
                    updatePreview();
                    showSelectionFeedback('Tema', option.querySelector('.color-name').textContent);
                }
            });

            // --- LISTENERS PARA IMAGEN DE FONDO (LOGO) ---
            const fileInput = document.getElementById('background-file');
            const uploadBox = document.getElementById('upload-box');
            const previewImg = document.getElementById('background-preview');
            const uploadText = document.getElementById('upload-text');
            const removeBgBtn = document.getElementById('remove-bg-btn');

            uploadBox.addEventListener('click', (e) => {
                if (e.target !== removeBgBtn && !removeBgBtn.contains(e.target)) {
                     fileInput.click();
                }
            });
            
            fileInput.addEventListener('change', async function() {
                const file = this.files[0];
                if (file) {
                    try {
                        // Llama a fileToBase64, que ahora valida el formato PNG
                        const base64Image = await fileToBase64(file); 
                        personalizationState.preferences.backgroundImage = base64Image;
                        
                        previewImg.src = base64Image;
                        previewImg.style.display = 'block';
                        uploadText.textContent = `Logo cargado: ${file.name}`;
                        removeBgBtn.style.display = 'block';
                        
                        applyBackground(); 
                        showSelectionFeedback('Logo', 'Nuevo logo de fondo aplicado');
                    } catch (error) {
                         // Si es un error de formato, el mensaje ya se mostró en fileToBase64
                        if (error.message.includes("Formato de archivo no permitido")) {
                            fileInput.value = ''; // Limpiar el input para que pueda seleccionar otro archivo
                            return; 
                        }
                        console.error("Error al convertir a Base64:", error);
                        showMessage('Error al cargar la imagen. Intenta con un archivo más pequeño o formato correcto.', 'error');
                    }
                }
            });
            
            removeBgBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                personalizationState.preferences.backgroundImage = null;
                fileInput.value = '';
                previewImg.src = '';
                previewImg.style.display = 'none';
                uploadText.textContent = 'Haz clic o arrastra para cambiar el logo';
                removeBgBtn.style.display = 'none';
                applyBackground();
                showSelectionFeedback('Logo', 'Logo RSI restaurado');
            });

            // Botón de guardar
            document.getElementById('save-btn').addEventListener('click', savePreferences);
            
            // Botón de restablecer
            document.getElementById('reset-btn').addEventListener('click', resetPreferences);
        }
        
        // Aplicar fondo seleccionado (ACTUALIZADA para Logo)
        function applyBackground() {
            const selectedBackground = backgroundOptions.find(bg => bg.id === personalizationState.preferences.background);
            const body = document.body;
            const bgImage = personalizationState.preferences.backgroundImage;
            
            // 1. Aplicar colores base
            document.documentElement.style.setProperty('--background-color', selectedBackground.color);
            document.documentElement.style.setProperty('--text-color', selectedBackground.textColor);
            document.documentElement.style.setProperty('--card-bg', selectedBackground.cardBg);
            
            // 2. Aplicar sombra (mantener)
            if (personalizationState.preferences.background === 'dark') {
                document.documentElement.style.setProperty('--card-shadow', '0 4px 12px rgba(0, 0, 0, 0.3)');
            } else {
                document.documentElement.style.setProperty('--card-shadow', '0 4px 12px rgba(0, 0, 0, 0.1)');
            }

            // 3. Aplicar LOGO (Custom o Default RSI)
            if (bgImage) {
                body.style.backgroundImage = `url('${bgImage}')`;
                body.style.backgroundSize = 'contain'; // Mantener el tamaño para que se vea bien
            } else {
                body.style.backgroundImage = 'var(--default-bg-image)';
                body.style.backgroundSize = '50vmax'; 
            }
            
            body.style.backgroundRepeat = 'no-repeat';
            body.style.backgroundPosition = 'center center';
            body.classList.add('has-custom-background'); 
        }
        
        // Aplicar tema seleccionado (mantener)
        function applyTheme() {
            const selectedTheme = themeOptions.find(theme => theme.id === personalizationState.preferences.theme);
            
            document.documentElement.style.setProperty('--primary-color', selectedTheme.primary);
            document.documentElement.style.setProperty('--secondary-color', selectedTheme.secondary);
            document.documentElement.style.setProperty('--accent-color', selectedTheme.accent);
        }
        
        // Actualizar vista previa (mantener)
        function updatePreview() {
            const selectedTheme = themeOptions.find(theme => theme.id === personalizationState.preferences.theme);
            
            document.getElementById('preview-primary').style.backgroundColor = selectedTheme.primary;
            document.getElementById('preview-primary').style.color = 'white';
            
            document.getElementById('preview-secondary').style.backgroundColor = selectedTheme.secondary;
            document.getElementById('preview-secondary').style.color = 'white';
            
            document.getElementById('preview-accent').style.backgroundColor = selectedTheme.accent;
            document.getElementById('preview-accent').style.color = 'white';
        }
        
        // Cargar perfil del usuario (mantener)
        async function loadUserProfile() {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                const colaboradorQuery = await db.collection("colaboradores")
                    .where("CORREO ELECTRÓNICO EMPRESARIAL", "==", user.email)
                    .get();
                
                if (!colaboradorQuery.empty) {
                    const doc = colaboradorQuery.docs[0];
                    const userData = doc.data();
                    
                    personalizationState.userData = {
                        id: doc.id,
                        nombre: userData.NOMBRE || 'Usuario',
                        correoEmpresarial: userData["CORREO ELECTRÓNICO EMPRESARIAL"]
                    };
                } else {
                    personalizationState.userData = {
                        id: user.uid,
                        nombre: user.email,
                        correoEmpresarial: user.email
                    };
                }
                
            } catch (error) {
                console.error("Error al cargar perfil:", error);
            }
        }
        
        // Cargar preferencias guardadas (mantener)
        async function loadSavedPreferences() {
            const savedPrefs = localStorage.getItem('personalizationPreferences');
            
            if (savedPrefs) {
                try {
                    const prefs = JSON.parse(savedPrefs);
                    prefs.backgroundImage = prefs.backgroundImage === undefined ? null : prefs.backgroundImage;
                    personalizationState.preferences = prefs;
                    applySavedPreferences();
                    showMessage('Preferencias cargadas desde almacenamiento local', 'success');
                } catch (e) {
                    console.error('Error al cargar preferencias desde localStorage:', e);
                }
            }
            
            // Intentar cargar desde Firebase si hay usuario autenticado
            if (personalizationState.currentUser && personalizationState.userData) {
                try {
                    const prefsDoc = await db.collection('personalizacion')
                        .where('colaboradorId', '==', personalizationState.userData.id)
                        .get();
                    
                    if (!prefsDoc.empty) {
                        const prefsData = prefsDoc.docs[0].data();
                        prefsData.preferences.backgroundImage = prefsData.preferences.backgroundImage === undefined ? null : prefsData.preferences.backgroundImage;
                        personalizationState.preferences = prefsData.preferences;
                        applySavedPreferences();
                        showMessage('Preferencias cargadas desde la base de datos', 'success');
                    }
                } catch (error) {
                    console.error('Error al cargar preferencias desde Firebase:', error);
                }
            }
        }
        
        // Aplicar preferencias guardadas (mantener)
        function applySavedPreferences() {
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));

            // Aplicar fondo (color)
            const backgroundOption = document.querySelector(`#background-options .color-option[data-id="${personalizationState.preferences.background}"]`);
            if (backgroundOption) {
                backgroundOption.classList.add('selected');
            }
            
            // Aplicar tema
            const themeOption = document.querySelector(`#theme-options .color-option[data-id="${personalizationState.preferences.theme}"]`);
            if (themeOption) {
                themeOption.classList.add('selected');
            }
            
            // Aplicar la imagen de logo (SOLO A LA MINIATURA Y AL BODY)
            const bgImage = personalizationState.preferences.backgroundImage;
            const previewImg = document.getElementById('background-preview');
            const uploadText = document.getElementById('upload-text');
            const removeBgBtn = document.getElementById('remove-bg-btn');

            if (bgImage) {
                previewImg.src = bgImage;
                previewImg.style.display = 'block';
                uploadText.textContent = `Logo cargado (Guardado)`;
                removeBgBtn.style.display = 'block';
            } else {
                previewImg.style.display = 'none';
                uploadText.textContent = 'Haz clic o arrastra para cambiar el logo';
                removeBgBtn.style.display = 'none';
            }

            // Aplicar todos los estilos de color y logo
            applyBackground(); 
            applyTheme();
            updatePreview();
        }
        
        // Guardar preferencias (mantener)
        async function savePreferences() {
            try {
                const selectedTheme = themeOptions.find(theme => theme.id === personalizationState.preferences.theme);
                const selectedBackground = backgroundOptions.find(bg => bg.id === personalizationState.preferences.background);
                const hasImage = !!personalizationState.preferences.backgroundImage;
                
                const result = await Swal.fire({
                    title: '¿Guardar preferencias?',
                    html: `
                        <div style="text-align: left; margin: 15px 0;">
                            <p><strong>Fondo:</strong> ${selectedBackground.name}</p>
                            <p><strong>Tema:</strong> ${selectedTheme.name}</p>
                            <p><strong>Logo de Fondo:</strong> ${hasImage ? 'Personalizado' : 'RSI por defecto'}</p>
                        </div>
                        <p>¿Estás seguro de que deseas guardar estas preferencias?</p>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: selectedTheme.primary,
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, guardar',
                    cancelButtonText: 'Cancelar',
                    background: selectedBackground.cardBg,
                    color: selectedBackground.textColor
                });
                
                if (!result.isConfirmed) return;
                
                localStorage.setItem('personalizationPreferences', JSON.stringify(personalizationState.preferences));
                
                if (personalizationState.currentUser && personalizationState.userData) {
                    await db.collection('personalizacion').doc(personalizationState.userData.id).set({
                        colaboradorId: personalizationState.userData.id,
                        colaboradorNombre: personalizationState.userData.nombre,
                        colaboradorEmail: personalizationState.userData.correoEmpresarial,
                        preferences: personalizationState.preferences, 
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    await Swal.fire({
                        title: '¡Guardado!',
                        text: 'Preferencias guardadas correctamente en la base de datos y local',
                        icon: 'success',
                        confirmButtonColor: selectedTheme.primary,
                        background: selectedBackground.cardBg,
                        color: selectedBackground.textColor
                    });
                } else {
                    await Swal.fire({
                        title: '¡Guardado!',
                        text: 'Preferencias guardadas en local (inicia sesión para guardar en la nube)',
                        icon: 'success',
                        confirmButtonColor: selectedTheme.primary,
                        background: selectedBackground.cardBg,
                        color: selectedBackground.textColor
                    });
                }
                
                updateNavigationMenu();
                
            } catch (error) {
                console.error('Error al guardar preferencias:', error);
                
                const selectedTheme = themeOptions.find(theme => theme.id === personalizationState.preferences.theme);
                const selectedBackground = backgroundOptions.find(bg => bg.id === personalizationState.preferences.background);
                
                await Swal.fire({
                    title: 'Error',
                    text: 'Error al guardar preferencias: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: selectedTheme.primary,
                    background: selectedBackground.cardBg,
                    color: selectedBackground.textColor
                });
            }
        }
        
        // Actualizar el menú de navegación con las nuevas preferencias (mantener)
        function updateNavigationMenu() {
            if (typeof updateMenuStyles === 'function') {
                updateMenuStyles(personalizationState.preferences); 
                console.log('Menú de navegación actualizado con las nuevas preferencias');
            } else {
                console.log('La función updateMenuStyles no está disponible. Asegúrate de que el script navegacion-operador.js la defina.');
            }
        }
        
        // Restablecer preferencias (mantener)
        async function resetPreferences() {
            const selectedTheme = themeOptions.find(theme => theme.id === personalizationState.preferences.theme);
            const selectedBackground = backgroundOptions.find(bg => bg.id === personalizationState.preferences.background);
            
            const result = await Swal.fire({
                title: '¿Restablecer preferencias?',
                text: '¿Estás seguro de que deseas restablecer todo a los valores por defecto (Fondo: Oscuro, Tema: Púrpura, Logo RSI)?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: selectedTheme.primary,
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, restablecer',
                cancelButtonText: 'Cancelar',
                background: selectedBackground.cardBg,
                color: selectedBackground.textColor
            });
            
            if (!result.isConfirmed) return;
            
            personalizationState.preferences = {
                background: 'dark', 
                theme: 'purple',
                backgroundImage: null
            };
            
            applySavedPreferences();
            updateNavigationMenu();
            
            await Swal.fire({
                title: '¡Restablecido!',
                text: 'Preferencias restablecidas a valores por defecto',
                icon: 'success',
                confirmButtonColor: '#6C43E0', 
                background: '#f5f5f5',
                color: '#333'
            });
        }
        
        // Mostrar mensajes (mantener)
        function showMessage(text, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
        
        // Mostrar feedback de selección (mantener)
        function showSelectionFeedback(type, value) {
            const selectedTheme = themeOptions.find(theme => theme.id === personalizationState.preferences.theme);
            const selectedBackground = backgroundOptions.find(bg => bg.id === personalizationState.preferences.background);
            
            Swal.fire({
                title: `${type} seleccionado`,
                text: `Has seleccionado: ${value}`,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false,
                background: selectedBackground.cardBg,
                color: selectedBackground.textColor,
                iconColor: selectedTheme.primary
            });
        }
    </script>
    <script src="../js/navegación-operador.js"></script>
</body>
</html>