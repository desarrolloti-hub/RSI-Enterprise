<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toma de Asistencias</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="asistencia.css"> ¬† ¬†

 
</head>
<body>
    <div class="attendance-container app-hidden" id="attendanceContainer">
        
        <div class="attendance-form-content" id="attendanceFormContent">
            <div class="attendance-header">
                <h1>Toma de Asistencias</h1>
                <p>Registra tu estatus laboral para el d√≠a de hoy</p>
            </div>

            <div class="employee-info">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" alt="Empleado" class="employee-avatar" id="employeeAvatar"> 
                <div class="employee-details">
                    <h3></h3> 
                    <p></p> 
                    <p></p>
                </div>
            </div>

            <div class="attendance-options">
                <div class="attendance-date" id="attendanceDate">
                    <i class="fas fa-calendar-day"></i> <span id="currentDate"></span>
                </div>

                <div class="options-grid">
                    <div class="attendance-option" data-value="office">
                        <div class="checkbox"></div>
                        <div class="option-icon"><i class="fas fa-building"></i></div>
                        <div class="option-label">En oficina</div>
                        <div class="option-desc">Asistencia presencial en oficina principal</div>
                    </div>

                    <div class="attendance-option" data-value="site">
                        <div class="checkbox"></div>
                        <div class="option-icon"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="option-label">En sitio</div>
                        <div class="option-desc">Trabajando en ubicaci√≥n del cliente</div>
                    </div>

                    <div class="attendance-option" data-value="iztapaluca">
                        <div class="checkbox"></div>
                        <div class="option-icon"><i class="fas fa-building"></i></div>
                        <div class="option-label">En oficina de Ixtapaluca</div>
                        <div class="option-desc">Trabajando en oficina de Ixtapaluca</div>
                    </div>

                    <div class="attendance-option" data-value="sick">
                        <div class="checkbox"></div>
                        <div class="option-icon"><i class="fas fa-procedures"></i></div>
                        <div class="option-label">Incapacidad</div>
                        <div class="option-desc">Ausencia por enfermedad/incapacidad</div>
                    </div>
                </div>
            </div>

            <button class="submit-btn" id="submitAttendance">
                <i class="fas fa-check-circle"></i> Registrar Asistencia
            </button>
        </div>

        <div id="tetris-container" class="app-hidden">
            <h2 id="tetris-title">Tiempo Extra: ¬°Hora de Tetris!</h2>
            <p id="tetris-message">Tu asistencia excede los limites, juega un rato hasta el d√≠a de ma√±ana y no olvides registrar tu asistencia a tu hora de entrada.</p>
            <div id="game-info">
                <div>Puntuaci√≥n: <span id="score">0</span></div>
                <div>R√©cord: <span id="highScore">0</span></div>
            </div>
            <canvas id="tetris-canvas"></canvas> 
            <div id="tetris-controls">
                <p>Flechas: Mover / Rotar | Abajo: Ca√≠da suave | Espacio: Ca√≠da r√°pida</p>
                <button onclick="startGame()" id="start-btn">Iniciar Juego</button>
            </div>
            
            <div class="touch-controls" id="touchControls">
                <button class="control-button" data-action="left"><i class="fas fa-arrow-left"></i></button>
                <button class="control-button" data-action="rotate"><i class="fas fa-sync-alt"></i></button>
                <button class="control-button" data-action="down"><i class="fas fa-arrow-down"></i></button>
                <button class="control-button" data-action="drop"><i class="fas fa-caret-down"></i></button>
                <button class="control-button" data-action="right"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
    
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-box">
            <div class="alert-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="alert-title">¬°Asistencia registrada!</h3>
            <p class="alert-message">Tu asistencia ha sido registrada correctamente para el d√≠a de hoy.</p>
            <button class="alert-btn" id="alertBtn">Aceptar</button>
        </div>
    </div>

    <div class="alert-overlay" id="errorAlert">
        <div class="alert-box error-alert-box">
            <div class="alert-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h3 class="alert-title">¬°Selecciona una opci√≥n!</h3>
            <p class="alert-message">Debes seleccionar un tipo de asistencia antes de continuar.</p>
            <button class="alert-btn" id="errorBtn">Entendido</button>
        </div>
    </div>

    <div class="alert-overlay" id="locationOverlay">
        <div class="alert-box location-alert-box">
            <div class="alert-icon">
                <i class="fas fa-map-marker-alt"></i> </div>
            <h3 class="alert-title">Otorga todos los permisos</h3>
            <p class="alert-message">Otorgar todos los permisos te dara acceso completo a la app web Rsi.</p>
            <button class="alert-btn location-alert-btn" id="locationBtn">Otorgar permisos</button>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    
    <script>

document.addEventListener('DOMContentLoaded', function() {
    // ----------------------------------------------------------------------------------
    // 1. Configuraci√≥n y Elementos DOM
    // ----------------------------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
        authDomain: "rsienterprise.firebaseapp.com",
        databaseURL: "https://rsienterprise-default-rtdb.firebaseio.com",
        projectId: "rsienterprise",
        storageBucket: "rsienterprise.appspot.com",
        messagingSenderId: "1063117165770",
        appId: "1:1063117165770:web:8555f26b25ae80bc42d033",
        measurementId: "G-38F2DBG9HE"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // Elementos del DOM
    const attendanceContainer = document.getElementById('attendanceContainer');
    const attendanceFormContent = document.getElementById('attendanceFormContent');
    const tetrisContainer = document.getElementById('tetris-container');
    const employeeAvatar = document.getElementById('employeeAvatar'); // <-- Elemento de la imagen
    const employeeDetails = document.querySelector('.employee-details');
    const currentDateElement = document.getElementById('currentDate');
    const attendanceOptions = document.querySelectorAll('.attendance-option');
    const submitBtn = document.getElementById('submitAttendance');
    const optionsGrid = document.querySelector('.options-grid');
    const alertOverlay = document.getElementById('alertOverlay');
    const alertBtn = document.getElementById('alertBtn');
    const errorAlert = document.getElementById('errorAlert');
    const errorBtn = document.getElementById('errorBtn');
    const locationOverlay = document.getElementById('locationOverlay');
    const locationBtn = document.getElementById('locationBtn');
    const tetrisTitle = document.getElementById('tetris-title');
    const tetrisMessage = document.getElementById('tetris-message');

    // Variables globales para el Easter Egg
    let longPressTimer;
    const LONG_PRESS_DELAY = 5000; // 5 segundos
    
    // ----------------------------------------------------------------------------------
    // 2. Funciones de UTILIDAD y VALIDACI√ìN
    // ----------------------------------------------------------------------------------

    async function getUserRole(email) {
        try {
            const querySnapshot = await db.collection('usuarios')
                .where('email', '==', email)
                .limit(1)
                .get();
            return !querySnapshot.empty ? querySnapshot.docs[0].data().rol : null;
        } catch (error) {
            console.error("Error al obtener rol del usuario:", error);
            return null;
        }
    }

    // MUESTRA EL JUEGO DE TETRIS (A√±adido par√°metro isEasterEgg)
    function loadTetris(userName, isEasterEgg = false) {
        
        // Verificaci√≥n de emergencia: Si el canvas o el contexto fallan, regresamos al formulario.
        if (!canvas || !ctx) {
             console.error("Fallo al inicializar el canvas de Tetris. Mostrando formulario de respaldo.");
             attendanceFormContent.classList.remove('app-hidden');
             tetrisContainer.classList.add('app-hidden');
             showAlert('error', 'Error de carga', 'El juego no pudo cargarse.');
             submitBtn.disabled = true;
             return;
        }

        // OCULTA EL FORMULARIO Y MUESTRA EL JUEGO DENTRO DEL MISMO CONTENEDOR
        attendanceFormContent.classList.add('app-hidden');
        tetrisContainer.classList.remove('app-hidden');
        
        // Mensaje personalizado
        if (isEasterEgg) {
            tetrisTitle.textContent = '¬°EASTER EGG ACTIVADO!';
            tetrisMessage.innerHTML = '¬°Encontraste el Easter Egg puesto por los ingenieros Emanuel Campa y Victor Ramirez! Ahora, ¬°a jugar un momento!';
        } else {
            tetrisTitle.textContent = '¬°Tu asistencia excede los l√≠mites!';
            tetrisMessage.innerHTML = 'Juega un rato hasta el d√≠a de ma√±ana y no olvides registrar tu asistencia a tu hora de entrada.';
        }
        
        document.getElementById('highScore').textContent = highscore;
        initTetris(); 
        
        // Iniciar el juego autom√°ticamente (si no est√° ya iniciado/pausado)
        if (!animationFrameId) {
             startGame();
        }
    }

    // Funci√≥n de VALIDACI√ìN DE HORA (De 05:00 AM a 14:00 PM hora M√©xico)
    function isTimeValid() {
        const now = new Date();
        const formatter = new Intl.DateTimeFormat('es-MX', {
            hour: '2-digit',
            minute: '2-digit',
            hourCycle: 'h23',
            timeZone: 'America/Mexico_City' // Zona horaria de la Ciudad de M√©xico
        });
        
        const parts = formatter.formatToParts(now);
        const hourPart = parts.find(p => p.type === 'hour');
        const currentHour = parseInt(hourPart.value, 10);
        
        if (currentHour >= 5 && currentHour < 14) {
            return { valid: true, error: null };
        } else if (currentHour < 5) {
            return { valid: false, error: '¬°A√∫n no es hora!', message: 'El registro de asistencia est√° disponible a partir de las 05:00 AM (Hora de M√©xico).' };
        } else { // currentHour >= 14 (2:00 PM o m√°s tarde)
             return { valid: false, error: '¬°Hora l√≠mite superada!', message: 'El registro de asistencia ha cerrado. Ahora puedes relajarte y jugar un momento.' };
        }
    }

    async function getUserData(email) {
        try {
            let querySnapshot = await db.collection('colaboradores')
                .where('CORREO ELECTR√ìNICO EMPRESARIAL', '==', email)
                .limit(1)
                .get();
            if (querySnapshot.empty) {
                querySnapshot = await db.collection('colaboradores')
                    .where('CORREO ELECTR√ìNICO EMPRESARIAL', '>=', email.toLowerCase())
                    .where('CORREO ELECTR√ìNICO EMPRESARIAL', '<=', email.toLowerCase() + '\uf8ff')
                    .limit(1)
                    .get();
            }
            return !querySnapshot.empty ? { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() } : null;
        } catch (error) { console.error("Error al obtener datos del usuario:", error); return null; }
    }

    async function checkActiveAttendanceFromCollaborators(email) {
        try {
            const collaboratorQuery = await db.collection('colaboradores')
                .where('CORREO ELECTR√ìNICO EMPRESARIAL', '==', email)
                .limit(1)
                .get();
            if (collaboratorQuery.empty) return null;
            const collaboratorData = collaboratorQuery.docs[0].data();
            const collaboratorId = collaboratorQuery.docs[0].id;
            if (collaboratorData.asistencia?.estado === true && collaboratorData.asistencia?.fecha) {
                const lastAttendanceDate = collaboratorData.asistencia.fecha.toDate();
                const today = new Date();
                if (lastAttendanceDate.getDate() === today.getDate() && lastAttendanceDate.getMonth() === today.getMonth() && lastAttendanceDate.getFullYear() === today.getFullYear()) {
                    return { id: collaboratorId, ...collaboratorData, horaRegistro: lastAttendanceDate.toLocaleTimeString('es-ES') };
                }
            }
            return null;
        } catch (error) { console.error("Error al verificar asistencia activa:", error); return null; }
    }

    // CORRECCI√ìN FINAL APLICADA AQU√ç para asegurar que se lean campos con caracteres especiales/acentos y reescribir todo el HTML interno
    function displayUserInfo(user) {
        // Aseguramos que los campos se lean con notaci√≥n de corchetes
        const area = user['√ÅREA'] || 'No especificado';
        const nit = user.NIT || 'ID no disponible'; // Asumiendo que NIT es el ID
        const rfc = user.RFC || 'No disponible';
        const telefono = user['TEL√âFONO MOVIL'] || 'No disponible';

        employeeDetails.innerHTML = `
            <h3>${user.NOMBRE || 'Nombre no disponible'}</h3>
            <p><strong>√Årea:</strong> ${area}</p>
            <p><strong>ID Empleado:</strong> ${nit}</p>
            <p><strong>RFC:</strong> ${rfc}</p>
            <p><strong>Tel√©fono:</strong> ${telefono}</p>
            <p><strong>Asistencia hoy:</strong> ${user.asistencia?.estado ? '<span style="color: var(--success);">Presente</span>' : '<span style="color: var(--error);">Pendiente</span>'}</p>
        `;
        
        // L√≥gica para la imagen del avatar
        if (user.imagen) {
            employeeAvatar.src = user.imagen;
        } else {
            const name = user.NOMBRE || '';
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
            // Generar avatar con iniciales si no hay imagen
            employeeAvatar.src = `https://ui-avatars.com/api/?name=${initials}&background=4e54c8&color=fff&size=128`;
        }
    }

    let userCoordinates = null;
    function getLocation() { 
          return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                const timeout = setTimeout(() => {
                    reject(new Error("Tiempo de espera agotado al obtener ubicaci√≥n"));
                }, 15000); 

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(timeout); 
                        if (position.coords.accuracy > 100) {
                            reject(new Error("La precisi√≥n de la ubicaci√≥n es demasiado baja. Intenta en un √°rea con mejor se√±al."));
                            return;
                        }

                        userCoordinates = {
                            latitude: Math.round(position.coords.latitude * 1000) / 1000, 
                            longitude: Math.round(position.coords.longitude * 1000) / 1000, 
                            accuracy: position.coords.accuracy,
                            timestamp: firebase.firestore.Timestamp.fromDate(new Date())
                        };
                        
                        sessionStorage.setItem('userCoordinates', JSON.stringify(userCoordinates));
                        resolve(userCoordinates);
                    },
                    (error) => {
                        clearTimeout(timeout); 
                        let errorMessage = "Error desconocido";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: errorMessage = "Permiso de ubicaci√≥n denegado. Por favor habilita los permisos."; break;
                            case error.POSITION_UNAVAILABLE: errorMessage = "La informaci√≥n de ubicaci√≥n no est√° disponible."; break;
                            case error.TIMEOUT: errorMessage = "La solicitud de ubicaci√≥n ha caducado. Intenta nuevamente."; break;
                        }
                        reject(new Error(errorMessage));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                reject(new Error("Geolocalizaci√≥n no soportada por el navegador"));
            }
        });
    }

    async function getFallbackLocation() { 
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return {
                latitude: data.latitude,
                longitude: data.longitude,
                accuracy: 5000, 
                source: 'ip'
            };
        } catch (error) {
            return null;
        }
    }

    // Funci√≥n actualizada para mostrar fecha y hora
    function updateDateTime() {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        currentDateElement.textContent = now.toLocaleDateString('es-ES', options);
    }
    
    async function registerAttendance(attendanceType, userData) {
        try {
            const now = new Date();
            const timestamp = firebase.firestore.Timestamp.fromDate(now);
            
            if (!userCoordinates) {
                try {
                    const storedCoords = sessionStorage.getItem('userCoordinates');
                    if (storedCoords) {
                        userCoordinates = JSON.parse(storedCoords);
                    } else {
                        userCoordinates = await getLocation();
                    }
                } catch (error) {
                    userCoordinates = await getFallbackLocation();
                }
            }
            
            await db.collection('colaboradores').doc(userData.id).update({
                asistencia: { estado: true, tipo: attendanceType, fecha: timestamp },
                ultimaAsistencia: timestamp
            });

            const attendanceData = {
                userId: userData.id, email: userData['CORREO ELECTR√ìNICO EMPRESARIAL'], nombre: userData.NOMBRE,
                area: userData['√ÅREA'], tipo: attendanceType, fecha: timestamp,
                dia: now.toLocaleDateString('es-ES', { weekday: 'long' }),
                horaRegistro: now.toLocaleTimeString('es-ES'), activo: true, ubicacion: userCoordinates,
                detalles: { correoPersonal: userData['CORREO ELECTRONICO PERSONAL'], correoEmpresarial: userData['CORREO ELECTR√ìNICO EMPRESARIAL'], rfc: userData.RFC }
            };

            const batch = db.batch();
            const attendanceRef = db.collection('asistencias').doc();
            batch.set(attendanceRef, attendanceData);
            await batch.commit();
            
            const userRole = await getUserRole(userData['CORREO ELECTR√ìNICO EMPRESARIAL']);
            const ubicacionMsg = attendanceType === 'office' || attendanceType === 'iztapaluca' ? 'Oficina verificada' : 'Ubicaci√≥n del cliente verificada';
            
            showAlert('success', 'Asistencia registrada', 
                `Tu asistencia ha sido registrada correctamente.<br><strong>Tipo:</strong> ${getAttendanceTypeName(attendanceType)}<br><strong>Ubicaci√≥n:</strong> ${ubicacionMsg}<br>Ser√°s redirigido en 3 segundos...`
            );
            
            setTimeout(() => { redirectByRole(userRole); }, 3000);
            return true;
        } catch (error) { console.error("Error al registrar asistencia:", error); return false; }
    }

    function redirectByRole(role) {
        switch(role) {
            case 'puntoVenta': window.location.href = '../nav-puntoVenta/inicio.html'; break;
            case 'facturas': window.location.href = '../nav-facturas/facturas.html'; break;
            case 'colaborador': window.location.href = '../nav-operadores/gestion_Tickets.html'; break;
            case 'admincolaborador': window.location.href = '../gestion-tickets/gestion-tickets.html'; break;
            default: window.location.href = "../nav-operadores/gestion_Tickets.html";
        }
    }

    function getAttendanceTypeName(type) {
        const types = { 'office': 'En oficina', 'site': 'En sitio', 'iztapaluca': 'En oficina de Iztapaluca', 'sick': 'Incapacidad' };
        return types[type] || type;
    }

    // Mantener esta funci√≥n de alerta para las alertas que NO usan SweetAlert2
    function showAlert(type, title, message) {
        alertOverlay.classList.remove('show');
        errorAlert.classList.remove('show');
        
        const targetAlert = type === 'error' ? errorAlert : alertOverlay;
        const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
        
        targetAlert.querySelector('.alert-title').textContent = title;
        targetAlert.querySelector('.alert-message').innerHTML = message;
        targetAlert.querySelector('.alert-icon i').className = `fas ${icon}`;
        targetAlert.classList.add('show');
    }

    // Configurar el bot√≥n de enviar (MODIFICADO para Tetris)
    function setupSubmitButton(userData) {
        submitBtn.addEventListener('click', async function() {
            const selectedOption = document.querySelector('.attendance-option.selected');
            
            if (!selectedOption) {
                errorAlert.classList.add('show');
                if(optionsGrid) { optionsGrid.style.animation = 'shake 0.5s'; setTimeout(() => { optionsGrid.style.animation = ''; }, 500); }
                return;
            }

            const timeCheck = isTimeValid();
            if (!timeCheck.valid) {
                if (timeCheck.error === '¬°Hora l√≠mite superada!') {
                    // Si la hora es inv√°lida por l√≠mite, carga el Tetris en el mismo contenedor
                    loadTetris(userData.NOMBRE, false); 
                    return;
                }
                
                showAlert('error', timeCheck.error, timeCheck.message);
                return;
            }

            const attendanceType = selectedOption.getAttribute('data-value');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
            submitBtn.disabled = true;

            const success = await registerAttendance(attendanceType, userData);
            
            if (!success) {
                showAlert('error', 'Error al registrar', 'Hubo un problema al registrar tu asistencia. Por favor intenta nuevamente.');
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Registrar Asistencia';
                submitBtn.disabled = false;
            }
        });
    }

    // ----------------------------------------------------------------------------------
    // 3. L√≥gica de AUTENTICACI√ìN y CARGA 
    // ----------------------------------------------------------------------------------
    
    // Inicializar fecha y hora
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // *********************************************************************************
    // CORRECCI√ìN CR√çTICA DE VISIBILIDAD: Muestra el contenedor y el formulario interno
    attendanceContainer.classList.add('loaded'); 
    attendanceContainer.classList.remove('app-hidden');
    attendanceFormContent.classList.remove('app-hidden'); // Asegura que el formulario est√© visible inicialmente
    tetrisContainer.classList.add('app-hidden');         // Asegura que el Tetris est√© oculto inicialmente
    // *********************************************************************************

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("Usuario autenticado. Intentando cargar datos...");
            const userData = await getUserData(user.email);
            
            if (!userData) { 
                 console.error("No se encontraron datos de colaborador.");
                 showAlert('error', 'Datos no encontrados', 'No se encontraron datos para este usuario. Ser√°s redirigido a la p√°gina de inicio de sesi√≥n.');
                 setTimeout(() => { auth.signOut().then(() => { window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html"; }); }, 3000);
                 return; 
            }
            
            const userRole = await getUserRole(user.email);
            
            // Revisa si el rol tiene permiso (evita 'user' y 'admin')
            if (userRole === 'user' || userRole === 'admin') {
                 console.warn("Rol sin permisos.");
                 showAlert('error', 'Acceso denegado', 'No tienes permisos para acceder a esta funci√≥n. Ser√°s redirigido.');
                 setTimeout(() => { auth.signOut().then(() => { window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html"; }); }, 3000);
                 return;
            }
            
            const activeAttendance = await checkActiveAttendanceFromCollaborators(user.email);
            const timeCheck = isTimeValid();
            
            // 1. Caso: Asistencia ya registrada
            if (activeAttendance) {
                console.log("Asistencia ya registrada hoy. Redirigiendo...");
                displayUserInfo(activeAttendance);
                showAlert('info', '¬°Asistencia ya registrada hoy!', `Ya registraste tu asistencia hoy a las ${activeAttendance.horaRegistro}.<br>Ser√°s redirigido al panel en 3 segundos...`);
                setTimeout(() => { redirectByRole(userRole); }, 3000);
            
            // 2. Caso: Hora l√≠mite superada (14:00 PM) Y sin asistencia
            } else if (!timeCheck.valid && timeCheck.error === '¬°Hora l√≠mite superada!') {
                console.log("Hora l√≠mite superada. Intentando cargar Tetris...");
                // Muestra Tetris
                loadTetris(userData.NOMBRE, false);
            
            // 3. Caso: Dentro del horario permitido o Antes del horario permitido Y sin asistencia
            } else { 
                console.log("Dentro de horario o antes de las 5 AM. Mostrando formulario...");
                
                // Asegura que el formulario est√© visible y Tetris oculto
                attendanceFormContent.classList.remove('app-hidden'); 
                tetrisContainer.classList.add('app-hidden');
                
                displayUserInfo(userData);
                const storedCoords = sessionStorage.getItem('userCoordinates');
                if (!storedCoords) { locationOverlay.classList.add('show'); }
                setupSubmitButton(userData);
                
                // Si la hora es inv√°lida (antes de las 05:00 AM), muestra la alerta
                if (!timeCheck.valid) {
                    showAlert('error', timeCheck.error, timeCheck.message);
                }
            }
            
        } else {
            console.log("Usuario no autenticado. Redirigiendo a login.");
            window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html";
        }
    });

    // ----------------------------------------------------------------------------------
    // 4. L√≥gica del Juego de Tetris (Tama√±o Aumentado y Correcci√≥n de Color)
    // ----------------------------------------------------------------------------------

    const canvas = document.getElementById('tetris-canvas');
    const ctx = canvas ? canvas.getContext('2d') : null;
    
    // TAMA√ëO AUMENTADO PARA EL TETRIS
    const gridSize = 25; // Tama√±o del bloque en p√≠xeles
    const cols = 12;     // Columnas
    const rows = 24;     // Filas
    
    if (ctx) {
        canvas.width = cols * gridSize; 
        canvas.height = rows * gridSize;
    }

    let board;
    let currentPiece; // Ahora es un objeto { matrix, colorIndex }
    let currentX;
    let currentY;
    let score = 0;
    let highscore = localStorage.getItem('tetrisHighScore') || 0;
    let isGameOver = false;
    let dropCounter = 0;
    let dropInterval = 1000; 
    let lastTime = 0;
    let animationFrameId;

    const pieces = [
        [[1, 1, 1, 1], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]], // I (0)
        [[1, 1], [1, 1]], ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // O (1)
        [[1, 1, 0], [0, 1, 1], [0, 0, 0]], ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// S (2)
        [[0, 1, 1], [1, 1, 0], [0, 0, 0]], ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// Z (3)
        [[1, 1, 1], [0, 1, 0], [0, 0, 0]], ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// T (4)
        [[1, 0, 0], [1, 1, 1], [0, 0, 0]], ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// L (5)
        [[0, 0, 1], [1, 1, 1], [0, 0, 0]] ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // J (6)
    ];
    // Colores usados en el canvas
    const colors = ['cyan', 'yellow', 'lime', 'red', 'purple', 'orange', 'blue'];

    function initTetris() {
        if (!ctx) return; 
        board = Array(rows).fill(0).map(() => Array(cols).fill(0));
        updateScore(0);
        document.getElementById('highScore').textContent = highscore;
        newPiece();
        drawBoard();
        document.getElementById('start-btn').textContent = "Iniciar Juego";
    }

    function newPiece() {
        const rand = Math.floor(Math.random() * pieces.length);
        // Almacenar el √≠ndice + 1 para saber su color. 0 en el tablero significa vac√≠o.
        const pieceIndex = rand + 1; 
        currentPiece = {
            matrix: pieces[rand],
            colorIndex: pieceIndex
        };

        currentX = Math.floor(cols / 2) - Math.floor(currentPiece.matrix[0].length / 2);
        currentY = 0;
        
        if (!checkCollision(0, 0)) {
            isGameOver = true;
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null; // Detener el loop
            document.getElementById('start-btn').textContent = "Juego Terminado. Volver a empezar";
            
            if (score > highscore) {
                highscore = score;
                localStorage.setItem('tetrisHighScore', highscore);
                document.getElementById('highScore').textContent = highscore;
            }
        }
    }

    function checkCollision(offsetX, offsetY, pieceMatrix = currentPiece.matrix) {
        for (let y = 0; y < pieceMatrix.length; y++) {
            for (let x = 0; x < pieceMatrix[y].length; x++) {
                if (pieceMatrix[y][x]) {
                    const newX = currentX + x + offsetX;
                    const newY = currentY + y + offsetY;

                    const isOutsideHorizontal = newX < 0 || newX >= cols;
                    const isOutsideVertical = newY >= rows;
                    // Verificar colisi√≥n con piezas ya fijas (valor > 0)
                    const isCollidingWithBoard = newY >= 0 && board[newY] && board[newY][newX] > 0;

                    if (isOutsideHorizontal || isOutsideVertical || isCollidingWithBoard) {
                        return false;
                    }
                }
            }
        }
        return true;
    }

    function mergePiece() {
        for (let y = 0; y < currentPiece.matrix.length; y++) {
            for (let x = 0; x < currentPiece.matrix[y].length; x++) {
                if (currentPiece.matrix[y][x]) {
                    // Guardar el √≠ndice de color en el tablero
                    board[currentY + y][currentX + x] = currentPiece.colorIndex; 
                }
            }
        }
        clearLines();
        newPiece();
    }

    function clearLines() {
        let linesCleared = 0;
        for (let y = rows - 1; y >= 0; y--) {
            // Un valor diferente de 0 significa que la celda tiene un color (est√° llena)
            if (board[y].every(cell => cell !== 0)) {
                board.splice(y, 1);
                board.unshift(Array(cols).fill(0));
                linesCleared++;
                y++; 
            }
        }
        if (linesCleared > 0) {
            const points = [0, 40, 100, 300, 1200];
            updateScore(score + points[linesCleared]);
            // Aumentar la velocidad
            dropInterval *= 0.95; 
        }
    }

    function rotatePiece() {
        const pieceMatrix = currentPiece.matrix;
        const N = pieceMatrix.length;
        const newPieceMatrix = Array(N).fill(0).map(() => Array(N).fill(0));
        for (let y = 0; y < N; ++y) {
            for (let x = 0; x < N; ++x) {
                newPieceMatrix[x][N - 1 - y] = pieceMatrix[y][x];
            }
        }
        if (checkCollision(0, 0, newPieceMatrix)) {
            currentPiece.matrix = newPieceMatrix;
        }
    }

    function updateScore(newScore) {
        score = newScore;
        document.getElementById('score').textContent = score;
        if (score > highscore) {
            highscore = score;
            localStorage.setItem('tetrisHighScore', highscore);
            document.getElementById('highScore').textContent = highscore;
        }
    }

    // CORRECCI√ìN DE COLOR APLICADA AQU√ç: Usa el colorIndex del objeto currentPiece
    function drawBoard() {
        if (!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Dibujar el tablero est√°tico
        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const colorIndex = board[y][x];
                if (colorIndex > 0) {
                    // El color es colors[index - 1] porque los √≠ndices de color van de 1 a 7 (en el board) a 0 a 6 (en el array colors)
                    ctx.fillStyle = colors[colorIndex - 1]; 
                    ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
                    ctx.strokeStyle = '#000';
                    ctx.strokeRect(x * gridSize, y * gridSize, gridSize, gridSize);
                }
            }
        }

        // Dibujar la pieza actual en movimiento
        if (!isGameOver && currentPiece) {
            const pieceColor = colors[currentPiece.colorIndex - 1]; // Usa el color indexado
            
            for (let y = 0; y < currentPiece.matrix.length; y++) {
                for (let x = 0; x < currentPiece.matrix[y].length; x++) {
                    if (currentPiece.matrix[y][x]) {
                        ctx.fillStyle = pieceColor;
                        ctx.fillRect((currentX + x) * gridSize, (currentY + y) * gridSize, gridSize, gridSize);
                        ctx.strokeStyle = '#000';
                        ctx.strokeRect((currentX + x) * gridSize, (currentY + y) * gridSize, gridSize, gridSize);
                    }
                }
            }
        }
    }

    function gameLoop(time = 0) {
        if (isGameOver) return;
        
        const deltaTime = time - lastTime;
        lastTime = time;
        dropCounter += deltaTime;

        if (dropCounter > dropInterval) {
            if (checkCollision(0, 1)) {
                currentY++;
            } else {
                mergePiece();
            }
            dropCounter = 0;
        }

        drawBoard();
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    window.startGame = function() {
        if (isGameOver) {
            isGameOver = false;
            dropInterval = 1000;
            score = 0;
            initTetris();
            gameLoop();
            document.getElementById('start-btn').textContent = "Reiniciar Juego";
        } else if (!animationFrameId) {
            // Reanudar o iniciar
            gameLoop();
            document.getElementById('start-btn').textContent = "Pausar/Continuar";
        } else {
            // Pausar
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            document.getElementById('start-btn').textContent = "Continuar Juego";
        }
    }
    
    // Funci√≥n central de movimiento
    function movePiece(action) {
        // Ejecutar solo si el juego est√° activo y no terminado
        if (tetrisContainer.classList.contains('app-hidden') || isGameOver || !animationFrameId) return;
        
        if (action === 'left') {
            if (checkCollision(-1, 0)) currentX--;
        } else if (action === 'right') {
            if (checkCollision(1, 0)) currentX++;
        } else if (action === 'rotate') {
            rotatePiece();
        } else if (action === 'down') {
            if (checkCollision(0, 1)) {
                currentY++;
                updateScore(score + 1); 
            }
        } else if (action === 'drop') {
            while (checkCollision(0, 1)) {
                currentY++;
                updateScore(score + 2); 
            }
            mergePiece();
            dropCounter = 0;
        }
        drawBoard();
    }
    
    // ----------------------------------------------------------------------------------
    // 5. Controles (Teclado y T√°ctil), Alertas, y EASTER EGG (Click Largo)
    // ----------------------------------------------------------------------------------
    
    // --- L√≥gica del EASTER EGG ---
    
    // Funci√≥n para disparar fuegos artificiales
    function shootConfetti() {
        // Disparo principal
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
        // Disparo secundario (m√°s disperso)
        confetti({
            particleCount: 50,
            spread: 120,
            origin: { y: 0.8 },
            colors: ['#bb0000', '#ffffff', '#ffaa00']
        });
    }

    // Funci√≥n a ejecutar al detectar click largo
    function activateEasterEgg() {
        // Solo activar si no estamos ya en Tetris
        if (tetrisContainer.classList.contains('app-hidden')) {
            // 1. Muestra la alerta con SweetAlert2
            Swal.fire({
                title: 'üéâ ¬°EASTER EGG ENCONTRADO! üéâ',
                text: 'Este juego fue puesto por los ingenieros Emanuel Campa y Victor Ramirez para el desestr√©s. ¬°A disfrutar!',
                icon: 'success',
                confirmButtonText: '¬°A Jugar!',
                customClass: {
                    container: 'my-swal-container' 
                }
            }).then(() => {
                // 3. Carga Tetris despu√©s de cerrar la alerta (con el flag isEasterEgg en true)
                loadTetris(auth.currentUser?.displayName || 'Colaborador', true);
            });
            
            // 2. Dispara los fuegos artificiales
            shootConfetti();
        }
        clearTimeout(longPressTimer); // Limpiar el temporizador por si acaso
    }

    // Inicio de la pulsaci√≥n (mousedown o touchstart)
    function startLongPress() {
        // Prevenir la activaci√≥n si Tetris ya est√° visible
        if (!tetrisContainer.classList.contains('app-hidden')) {
            return;
        }
        // Configurar el temporizador para la activaci√≥n
        longPressTimer = setTimeout(activateEasterEgg, LONG_PRESS_DELAY);
    }

    // Fin de la pulsaci√≥n (mouseup, mouseleave o touchend/touchcancel)
    function cancelLongPress() {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }

    // Asociar eventos a la imagen (mousedown/mouseup para PC, touchstart/touchend para m√≥vil)
    employeeAvatar.addEventListener('mousedown', startLongPress);
    employeeAvatar.addEventListener('mouseup', cancelLongPress);
    employeeAvatar.addEventListener('mouseleave', cancelLongPress);

    // Soporte t√°ctil
    employeeAvatar.addEventListener('touchstart', startLongPress);
    employeeAvatar.addEventListener('touchend', cancelLongPress);
    employeeAvatar.addEventListener('touchcancel', cancelLongPress);

    // --- Controles de Tetris y Alertas (Original) ---

    // Controles de teclado
    document.addEventListener('keydown', (e) => {
        if (tetrisContainer.classList.contains('app-hidden') || isGameOver || !animationFrameId) return;

        if (e.key === 'ArrowLeft') {
            movePiece('left');
        } else if (e.key === 'ArrowRight') {
            movePiece('right');
        } else if (e.key === 'ArrowUp') {
            movePiece('rotate');
        } else if (e.key === 'ArrowDown') {
            movePiece('down');
        } else if (e.key === ' ') {
            e.preventDefault(); 
            movePiece('drop');
        }
    });

    // Controles T√°ctiles (Event Listeners)
    document.getElementById('touchControls').querySelectorAll('.control-button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault(); // Previene zoom o desplazamiento en algunos navegadores
            const action = this.getAttribute('data-action');
            movePiece(action);
        });
    });
    
    alertBtn.addEventListener('click', function() { alertOverlay.classList.remove('show'); });
    errorBtn.addEventListener('click', function() { errorAlert.classList.remove('show'); });
    
    locationBtn.addEventListener('click', async function() {
        locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Otorgando permisos';
        locationBtn.disabled = true;
        
        try {
            await getLocation();
            locationOverlay.classList.remove('show');
            showAlert('success', 'Perfil verificad@', 'Ahora puedes registrar tu asistencia.');
        } catch (error) {
            showAlert('error', 'Ubicaci√≥n requerida', error.message || 'No podemos continuar sin acceso a tu ubicaci√≥n.');
            locationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Intentar nuevamente';
            locationBtn.disabled = false;
        }
    });

    // Selecci√≥n de opciones de asistencia 
    attendanceOptions.forEach(option => {
        option.addEventListener('click', function() {
            attendanceOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

});
    </script>
    <script src="../js/navegaci√≥n-operador.js"></script>
    <script src="../js/personalizacion-colores.js"></script>
</body>
</html>