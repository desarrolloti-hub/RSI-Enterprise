<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="../../manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tickets | RSI Enterprise</title>
    <link rel="stylesheet" href="gestion-tickets.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Esta configuración debe coincidir con la de tu script de módulo.
        const firebaseConfigGlobal = {
            apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
            authDomain: "rsienterprise.firebaseapp.com",
            databaseURL: "https://rsienterprise-default-rtdb.firebaseio.com",
            projectId: "rsienterprise",
            storageBucket: "rsienterprise.appspot.com",
            messagingSenderId: "1063117165770",
            appId: "1:1063117165770:web:8555f26b25ae80bc42d033",
            measurementId: "G-38F2DBG9HE"
        };
        // Inicializar Firebase globalmente (v8)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfigGlobal);
        }
    </script>
</head>
<body>
    <div class="../css/img/Logo-RSI-OFICIAL.png"></div>
    <div id="mensajeAcceso" style="display: none;"></div>

    <div class="main-content">
        <div class="crud-header">
            <center>
            <h1 class="page-title">Mis Tickets</h1>
            </center>

            <button class="filter-btn" id="filterBtn">
                <i class="fas fa-filter"></i> 
                <span id="filterText">Ver Finalizados</span>
            </button>
        </div>

        <div class="tickets-grid" id="ticketsContainer">
            <div class="no-tickets">
                <i class="fas fa-ticket-alt"></i>
                <h3>Cargando tickets...</h3>
                <p>Por favor espera mientras se cargan tus tickets</p>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailTitle">Detalles del Ticket</h2>
                <span class="close">&times;</span>
            </div>
            <div id="detailContent">
                </div>
            <div class="modal-footer">
                <a href="#" class="action-btn finish-btn" id="finishTicketBtn" style="display: none;">
                    <i class="fas fa-check-circle"></i> Finalizar Ticket
                </a>
                <button type="button" class="action-btn edit-btn" id="editFinishBtn" style="display: none;">
                    <i class="fas fa-edit"></i> Modificar Finalización
                </button>
            </div>
        </div>
    </div>

    <div id="imageViewerModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; background: transparent; box-shadow: none;">
            <span class="close" style="position: absolute; top: 15px; right: 15px; color: rgb(0, 0, 0); font-size: 35px; z-index: 100;">&times;</span>
            <img id="expandedImage" style="width: 100%; height: auto; max-height: 90vh; object-fit: contain;">
        </div>
    </div>

    <div id="pdfProgressModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h2>Generando PDF</h2>
            </div>
            <div class="modal-body">
                <div class="pdf-progress">
                    <i class="fas fa-file-pdf fa-3x" style="color: #e74c3c; margin-bottom: 20px;"></i>
                    <p>Procesando información del ticket...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="pdfProgressFill"></div>
                    </div>
                    <p id="pdfProgressText">0%</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
    // Esquemas de datos (Se mantienen)
    const DataSchemas = {
        EVIDENCIA: {
            ticketId: '',
            colaboradorId: '',
            colaboradorNombre: '',
            descripcion: '',
            imagenes: [],
            fechaCreacion: null,
            fechaActualizacion: null,
            estado: 'pendiente' // pendiente | completado
        },
        TICKET: {
            evidenciasCompletadas: [], // array de colaboradorIds que han completado
            todosCompletados: false
        },
        PDF: {
            ticketId: '',
            nombreArchivo: '',
            fechaCreacion: null,
            colaboradorId: '',
            colaboradorNombre: '',
            contenido: '', // base64 del PDF
            tamaño: 0
        }
    };

    // Clase para manejar el estado del ticket (Se mantiene)
    class TicketManager {
        constructor() {
            this.currentTicketId = null;
            this.currentTicketStatus = null;
            this.showFinalized = false; // Estado del filtro
        }

        setCurrentTicket(ticketId, status) {
            this.currentTicketId = ticketId;
            this.currentTicketStatus = status;
        }

        clearCurrentTicket() {
            this.currentTicketId = null;
            this.currentTicketStatus = null;
        }

        toggleFilter() {
            this.showFinalized = !this.showFinalized;
            return this.showFinalized;
        }
    }

    // Instancia única del manager
    const ticketManager = new TicketManager();

    // Importar módulos necesarios de Firebase v9 (SOLO FIRESTORE)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        query, 
        where,
        getDocs,
        orderBy,
        doc,
        getDoc,
        limit,
        updateDoc,
        addDoc,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    // NOTA: Se eliminan todas las importaciones de Firebase Auth.

    // Configuración de Firebase (v9 - Mismo que v8)
    const firebaseConfig = {
        apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
        authDomain: "rsienterprise.firebaseapp.com",
        databaseURL: "https://rsienterprise-default-rtdb.firebaseio.com",
        projectId: "rsienterprise",
        storageBucket: "rsienterprise.appspot.com",
        messagingSenderId: "1063117165770",
        appId: "1:1063117165770:web:8555f26b25ae80bc42d033",
        measurementId: "G-38F2DBG9HE"
    };

    // Inicializar Firebase (Solo Firestore v9)
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elementos del DOM (Ajustados)
    const DOM = {
        ticketsContainer: document.getElementById('ticketsContainer'),
        filterBtn: document.getElementById('filterBtn'),
        filterText: document.getElementById('filterText'),
        finishTicketBtn: document.getElementById('finishTicketBtn'),
        editFinishBtn: document.getElementById('editFinishBtn')
    };

    // Estado de la aplicación (Se mantiene)
    const AppState = {
        userData: null,
        lastCheckedTicketId : null,
        ticketCheckInterval: null,
        notificationCheckInterval: 10000,
        allTickets: []
    };

    window.AppState = AppState;
    document.dispatchEvent(new Event('AppStateReady'));

    // Generador de PDF (Se mantiene, sin cambios de estilo)
    class PDFGenerator {
        constructor() {
            this.jsPDF = window.jspdf.jsPDF;
        }

        async generateTicketPDF(ticketData, evidencias) {
            try {
                this.showProgressModal();
                this.updateProgress(10, 'Inicializando generador PDF...');

                const pdf = new this.jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                let yPosition = 20;

                this.updateProgress(20, 'Añadiendo header...');
                await this.addHeader(pdf, pageWidth, yPosition);
                yPosition += 40;

                this.updateProgress(30, 'Añadiendo información básica...');
                yPosition = this.addBasicInfo(pdf, ticketData, yPosition, pageWidth);

                this.updateProgress(40, 'Añadiendo información adicional...');
                yPosition = this.addAdditionalInfo(pdf, ticketData, yPosition, pageWidth);

                this.updateProgress(50, 'Procesando evidencias...');
                if (evidencias && evidencias.length > 0) {
                    for (let i = 0; i < evidencias.length; i++) {
                        this.updateProgress(50 + (i / evidences.length) * 40, 'Añadiendo evidencias...');
                        yPosition = await this.addEvidenceSection(pdf, evidencias[i], yPosition, pageWidth, pageHeight);
                    }
                }

                this.updateProgress(95, 'Finalizando PDF...');
                
                const pdfBase64 = pdf.output('datauristring');
                await this.savePDFToFirebase(ticketData.id, pdfBase64);

                this.updateProgress(100, 'PDF generado exitosamente');
                
                const fileName = `Ticket_${ticketData.id.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                setTimeout(() => {
                    this.hideProgressModal();
                    Swal.fire({
                        icon: 'success',
                        title: 'PDF Generado',
                        text: 'El PDF se ha generado y guardado exitosamente',
                        confirmButtonColor: '#3085d6'
                    });
                }, 1000);

            } catch (error) {
                console.error('Error generando PDF:', error);
                this.hideProgressModal();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo generar el PDF: ' + error.message,
                    confirmButtonColor: '#3085d6'
                });
            }
        }

        async addHeader(pdf, pageWidth, yPosition) {
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(102, 126, 234);
            pdf.text('REPORTE DE TICKET - RSI ENTERPRISE', pageWidth / 2, yPosition, { align: 'center' });
            
            pdf.setDrawColor(102, 126, 234);
            pdf.setLineWidth(2);
            pdf.line(20, yPosition + 5, pageWidth - 20, yPosition + 5);
            
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(100, 100, 100);
            pdf.text(`Generado el: ${new Date().toLocaleDateString('es-MX')} a las ${new Date().toLocaleTimeString('es-MX')}`, pageWidth - 20, yPosition + 15, { align: 'right' });
        }

        addBasicInfo(pdf, ticketData, yPosition, pageWidth) {
            const shortId = ticketData.id.substring(0, 8);
            
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(44, 62, 80);
            pdf.text('INFORMACIÓN BÁSICA', 20, yPosition);
            yPosition += 10;

            const basicInfo = [
                ['ID del Ticket:', `#${shortId.toUpperCase()}`],
                ['Título:', ticketData.titulo || 'Sin título'],
                ['Estado:', (ticketData.estado || 'desconocido').replace('_', ' ').toUpperCase()],
                ['Prioridad:', (ticketData.prioridad || 'media').toUpperCase()],
                ['Área:', ticketData.area || 'General'],
                ['Responsable:', ticketData.responsableNombre || 'No asignado'],
                ['Fecha de Creación:', this.formatDate(ticketData.fechaCreacion)],
                ['Última Actualización:', this.formatDate(ticketData.fechaActualizacion)],
            ];

            if (ticketData.fechaFinalizacion) {
                basicInfo.push(['Fecha de Finalización:', this.formatDate(ticketData.fechaFinalizacion)]);
            }

            yPosition = this.addTable(pdf, basicInfo, yPosition, pageWidth);
            
            return yPosition + 10;
        }

        addAdditionalInfo(pdf, ticketData, yPosition, pageWidth) {
            if (ticketData.descripcionActividades) {
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(44, 62, 80);
                pdf.text('DESCRIPCIÓN DEL PROYECTO', 20, yPosition);
                yPosition += 10;

                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                
                const splitDescription = pdf.splitTextToSize(ticketData.descripcionActividades, pageWidth - 40);
                pdf.text(splitDescription, 20, yPosition);
                yPosition += splitDescription.length * 5 + 10;
            }

            const additionalData = [];
            if (ticketData.servicio) additionalData.push(['Servicio:', ticketData.servicio]);
            if (ticketData.proyecto) additionalData.push(['Proyecto:', ticketData.proyecto]);
            if (ticketData.ordenServicio) additionalData.push(['Orden de Servicio:', ticketData.ordenServicio]);
            if (ticketData.rfc) additionalData.push(['RFC:', ticketData.rfc]);
            if (ticketData.direccionFiscal) additionalData.push(['Dirección Fiscal:', ticketData.direccionFiscal]);
            if (ticketData.cuenta) additionalData.push(['Cuenta:', ticketData.cuenta]);

            if (additionalData.length > 0) {
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text('INFORMACIÓN ADICIONAL', 20, yPosition);
                yPosition += 10;
                
                yPosition = this.addTable(pdf, additionalData, yPosition, pageWidth);
                yPosition += 10;
            }

            return yPosition;
        }

        async addEvidenceSection(pdf, evidencia, yPosition, pageWidth, pageHeight) {
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = 20;
            }

            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(44, 62, 80);
            pdf.text(`EVIDENCIAS DE: ${evidencia.colaboradorNombre}`, 20, yPosition);
            yPosition += 10;

            if (evidencia.descripcion) {
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Descripción del trabajo realizado:', 20, yPosition);
                yPosition += 8;

                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                const splitDescription = pdf.splitTextToSize(evidencia.descripcion, pageWidth - 40);
                pdf.text(splitDescription, 20, yPosition);
                yPosition += splitDescription.length * 5 + 10;
            }

            if (evidencia.imagenes && evidencia.imagenes.length > 0) {
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`Imágenes de evidencia (${evidencia.imagenes.length}):`, 20, yPosition);
                yPosition += 10;

                const imageWidth = 73; // 7.3 cm
                const imageHeight = 100; // 10 cm
                const imagesPerRow = 2;
                let imageCount = 0;

                for (const imageUrl of evidencia.imagenes) {
                    try {
                        if (yPosition + imageHeight > pageHeight - 20) {
                            pdf.addPage();
                            yPosition = 20;
                        }

                        const xPosition = 20 + (imageCount % imagesPerRow) * (imageWidth + 10);
                        
                        await this.addImageToPDF(pdf, imageUrl, xPosition, yPosition, imageWidth, imageHeight);
                        
                        imageCount++;
                        
                        if (imageCount % imagesPerRow === 0) {
                            yPosition += imageHeight + 10;
                        }
                    } catch (error) {
                        console.error('Error añadiendo imagen:', error);
                    }
                }

                if (imageCount % imagesPerRow !== 0) {
                    yPosition += imageHeight + 10;
                }
            }

            return yPosition + 10;
        }

        async addImageToPDF(pdf, imageUrl, x, y, width, height) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = width * 4; // Resolución más alta
                        canvas.height = height * 4;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                        
                        pdf.addImage(dataURL, 'JPEG', x, y, width, height);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = () => reject(new Error('No se pudo cargar la imagen'));
                img.src = imageUrl;
            });
        }

        addTable(pdf, data, yPosition, pageWidth) {
            const rowHeight = 8;
            const colWidth = (pageWidth - 40) / 2;

            data.forEach(([label, value]) => {
                pdf.setFillColor(248, 249, 250);
                pdf.rect(20, yPosition - 5, pageWidth - 40, rowHeight, 'F');
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(44, 62, 80);
                pdf.text(label, 25, yPosition);
                
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                const splitValue = pdf.splitTextToSize(value, colWidth - 10);
                pdf.text(splitValue, 25 + colWidth, yPosition);
                
                yPosition += Math.max(rowHeight, splitValue.length * 5);
            });

            return yPosition;
        }

        formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const date = timestamp.toDate();
                return date.toLocaleDateString('es-MX', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Fecha inválida';
            }
        }

        async savePDFToFirebase(ticketId, pdfBase64) {
            try {
                const pdfData = {
                    ticketId: ticketId,
                    nombreArchivo: `Ticket_${ticketId.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`,
                    fechaCreacion: serverTimestamp(),
                    // NOTA: AppState.userData se cargará de la función loadUserTickets.
                    colaboradorId: AppState.userData.colaboradorId,
                    colaboradorNombre: AppState.userData.NOMBRE,
                    contenido: pdfBase64,
                    tamaño: Math.round(pdfBase64.length * 0.75) // Aproximar tamaño
                };

                await addDoc(collection(db, 'pdfMesa'), pdfData);
                console.log('PDF guardado en Firebase exitosamente');
            } catch (error) {
                console.error('Error guardando PDF en Firebase:', error);
                throw error;
            }
        }

        showProgressModal() {
            document.getElementById('pdfProgressModal').style.display = 'block';
        }

        hideProgressModal() {
            document.getElementById('pdfProgressModal').style.display = 'none';
        }

        updateProgress(percentage, text) {
            const progressFill = document.getElementById('pdfProgressFill');
            const progressText = document.getElementById('pdfProgressText');
            
            if (progressFill) progressFill.style.width = percentage + '%';
            if (progressText) progressText.textContent = Math.round(percentage) + '%';
            
            const progressTextElement = document.querySelector('#pdfProgressModal .modal-body p');
            if (progressTextElement && text) {
                progressTextElement.textContent = text;
            }
        }
    }

    // Instancia del generador de PDF
    const pdfGenerator = new PDFGenerator();

    // Funciones de utilidad (Se mantienen)
    const Utils = {
        showLoading: (message = 'Cargando...') => {
            Swal.fire({
                title: message,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
        },
        
        hideLoading: () => Swal.close(),
        
        showError: (message, title = 'Error') => {
            Swal.fire({
                icon: 'error',
                title: title,
                text: message,
                confirmButtonColor: '#3085d6'
            });
        },
        
        formatDate: (timestamp) => {
            if (!timestamp) return 'N/A';
            try {
                const date = timestamp.toDate();
                return date.toLocaleDateString('es-MX', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error("Error formateando fecha:", error);
                return 'Fecha inválida';
            }
        },
        
        getBadgeClass: (status) => {
            switch(status) {
                case 'finalizado': 
                case 'completado': 
                case 'cerrado': 
                    return 'badge-success';
                case 'en_proceso': 
                case 'en_camino': 
                    return 'badge-warning';
                case 'pendiente': 
                case 'pendiente_de_aceptación': 
                    return 'badge-danger';
                case 'aceptado': 
                    return 'badge-info';
                default: 
                    return 'badge-info';
            }
        },
        
        getStatusIcon: (status) => {
            switch(status) {
                case 'finalizado': 
                case 'completado': 
                case 'cerrado': 
                    return 'fa-check-circle';
                case 'en_proceso': 
                    return 'fa-spinner';
                case 'en_camino': 
                    return 'fa-truck';
                case 'pendiente': 
                case 'pendiente_de_aceptación': 
                    return 'fa-clock';
                case 'aceptado': 
                    return 'fa-check';
                default: 
                    return 'fa-question-circle';
            }
        },
        
        getPriorityClass: (priority) => {
            switch(priority) {
                case 'alta': return 'priority-high';
                case 'media': return 'priority-medium';
                case 'baja': return 'priority-low';
                default: return 'priority-medium';
            }
        },
        
        async showNotification(title, body, ticketId) {
            try {
                if (!('Notification' in window)) {
                    console.log("Notificaciones no soportadas");
                    return false;
                }

                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    if ('serviceWorker' in navigator) {
                        try {
                            const registration = await navigator.serviceWorker.ready;
                            
                            await registration.showNotification(title, {
                                body: body,
                                icon: 'https://rsienterprise.web.app/vista/css/img/logocon%20fondo.png',
                                badge: 'https://rsienterprise.web.app/vista/css/img/logocon%20fondo.png',
                                data: { 
                                    url: `https://rsienterprise.web.app/?ticketId=${ticketId}`,
                                    ticketId: ticketId
                                },
                                vibrate: [200, 100, 200],
                                actions: [
                                    { 
                                        action: 'view', 
                                        title: 'Ver Ticket',
                                        icon: 'https://rsienterprise.web.app/vista/css/img/icon-eye.png'
                                    }
                                ]
                            });
                            return true;
                        } catch (error) {
                            console.error("Error con Service Worker:", error);
                            new Notification(title, {
                                body: body,
                                icon: 'https://rsienterprise.web.app/vista/css/img/logocon%20fondo.png'
                            });
                            return true;
                        }
                    } else {
                        new Notification(title, {
                            body: body,
                            icon: 'https://rsienterprise.web.app/vista/css/img/logocon%20fondo.png'
                        });
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error("Error mostrando notificación:", error);
                return false;
            }
        }
    };

    // Controlador de Tickets 
    const TicketsController = {
        processTickets: (querySnapshot) => {
            const tickets = [];
            querySnapshot.forEach((doc) => {
                try {
                    const data = doc.data();
                    tickets.push({
                        id: doc.id,
                        ...data,
                        fechaCreacion: data.fechaCreacion,
                        fechaActualizacion: data.fechaActualizacion || null
                    });
                } catch (error) {
                    console.error("Error procesando ticket:", error);
                }
            });
            return tickets;
        },

        filterTickets: (tickets, showFinalized) => {
            if (showFinalized) {
                return tickets.filter(ticket => ticket.estado === 'finalizado');
            } else {
                return tickets.filter(ticket => ticket.estado !== 'finalizado');
            }
        },

        renderTickets: (tickets) => {
            try {
                const filteredTickets = TicketsController.filterTickets(tickets, ticketManager.showFinalized);
                DOM.ticketsContainer.innerHTML = '';
                
                if (!filteredTickets || filteredTickets.length === 0) {
                    const message = ticketManager.showFinalized 
                        ? 'No tienes tickets finalizados'
                        : 'No tienes tickets pendientes o en proceso';
                        
                    DOM.ticketsContainer.innerHTML = `
                        <div class="no-tickets">
                            <i class="fas fa-ticket-alt"></i>
                            <h3>${message}</h3>
                            <p>Cuando ${ticketManager.showFinalized ? 'finalices' : 'te asignen'} tickets, aparecerán aquí</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                filteredTickets.forEach(ticket => {
                    try {
                        const ticketId = ticket.id || 'ID-NO-DISPONIBLE';
                        const shortId = ticketId.substring(0, 8);
                        const estado = ticket.estado || 'desconocido';
                        const titulo = ticket.titulo || 'Sin título';
                        const descripcion = ticket.descripcionActividades || 'Sin descripción';
                        const prioridad = ticket.prioridad || 'media';
                        const area = ticket.area || 'General';
                        const fechaCreacion = ticket.fechaCreacion || null;
                        
                        const colaboradorInfo = ticket.colaborador ? `
                            <div class="ticket-meta">
                                <span class="badge badge-primary">
                                    <i class="fas fa-user"></i> ${ticket.colaborador.nombre || 'Sin nombre'}
                                </span>
                                <span class="badge badge-primary">
                                    <i class="fas fa-briefcase"></i> ${ticket.colaborador.puesto || 'Sin puesto'}
                                </span>
                            </div>
                        ` : '';
                        
                        html += `
                            <div class="ticket-card">
                                <div class="ticket-header">
                                    <span class="ticket-id">#${shortId.toUpperCase()}</span>
                                    <span class="badge ${Utils.getBadgeClass(estado)}">
                                        <i class="fas ${Utils.getStatusIcon(estado)}"></i> ${estado.replace('_', ' ')}
                                    </span>
                                </div>
                                <h3 class="ticket-title">${titulo}</h3>
                                <p class="ticket-desc">${descripcion.substring(0, 120)}${descripcion.length > 120 ? '...' : ''}</p>
                                
                                <div class="ticket-meta">
                                    <span class="badge badge-primary">
                                        <span class="priority-indicator ${Utils.getPriorityClass(prioridad)}"></span>
                                        ${prioridad}
                                    </span>
                                    <span class="badge badge-primary">
                                        <i class="fas fa-layer-group"></i> ${area}
                                    </span>
                                </div>
                                
                                ${colaboradorInfo}
                                
                                <div class="ticket-date">
                                    <i class="fas fa-calendar-alt"></i> ${Utils.formatDate(fechaCreacion)}
                                </div>
                                
                                <button class="action-btn view" data-id="${ticketId}">
                                    <i class="fas fa-eye"></i> Ver detalles
                                </button>
                            </div>
                        `;
                    } catch (error) {
                        console.error("Error renderizando ticket:", error);
                    }
                });
                
                DOM.ticketsContainer.innerHTML = html;
                
                document.querySelectorAll('.action-btn.view').forEach(btn => {
                    btn.addEventListener('click', () => TicketsController.showTicketDetails(btn.dataset.id));
                });
            } catch (error) {
                console.error("Error renderizando tickets:", error);
                Utils.showError("Error al mostrar los tickets");
            }
        },

        // ** LÓGICA DE CARGA DE TICKETS AJUSTADA **
        async loadUserTickets() {
            try {
                Utils.showLoading('Cargando tickets...');
                
                // 1. Obtener datos del usuario desde Firebase Auth (v8)
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('Usuario no autenticado.');
                }

                // 1.1. Buscar datos del colaborador por email (Usando Firestore v9)
                const colaboradoresRef = collection(db, 'colaboradores');
                const q2 = query(colaboradoresRef, where("CORREO ELECTRÓNICO EMPRESARIAL", "==", user.email));
                const collabSnapshot = await getDocs(q2);
                
                if (collabSnapshot.empty) {
                    throw new Error('No se encontraron tus datos de colaborador en la base de datos.');
                }
                
                collabSnapshot.forEach(doc => {
                    AppState.userData = doc.data();
                    AppState.userData.colaboradorId = doc.id;
                    AppState.userData.nombreCompleto = doc.data()['NOMBRE'];
                    // Asignar el nombre corto para compatibilidad
                    AppState.userData.NOMBRE = doc.data()['NOMBRE']; 
                    AppState.userData.ÁREA = doc.data()['ÁREA']; 
                });
                
                // 2. Continuar con la carga de tickets
                const ticketsRef = collection(db, 'ticketsmesa');
                const nombreResponsable = AppState.userData.nombreCompleto;
                const colaboradorId = AppState.userData.colaboradorId;
                
                let querySnapshot;
                try {
                    // Ejecutar consultas combinadas (Responsable y Colaborador)
                    const qResponsable = query(
                        ticketsRef,
                        where("responsableNombre", "==", nombreResponsable),
                        orderBy("fechaCreacion", "desc")
                    );
                    
                    const qColaborador = query(
                        ticketsRef,
                        where("colaboradores", "array-contains", colaboradorId),
                        orderBy("fechaCreacion", "desc")
                    );
                    
                    const [snapshotResponsable, snapshotColaborador] = await Promise.all([
                        getDocs(qResponsable),
                        getDocs(qColaborador)
                    ]);
                    
                    const allTickets = new Map();
                    snapshotResponsable.forEach(doc => { allTickets.set(doc.id, doc); });
                    snapshotColaborador.forEach(doc => { allTickets.set(doc.id, doc); });
                    
                    querySnapshot = {
                        docs: Array.from(allTickets.values()),
                        empty: allTickets.size === 0,
                        size: allTickets.size,
                        forEach: function(callback) { this.docs.forEach(doc => callback(doc)); }
                    };
                    
                } catch (error) {
                    if (error.code === 'failed-precondition') {
                        console.warn("Índice faltante, cargando tickets sin ordenar...");
                        const qResponsable = query(ticketsRef, where("responsableNombre", "==", nombreResponsable));
                        const qColaborador = query(ticketsRef, where("colaboradores", "array-contains", colaboradorId));
                        
                        const [snapshotResponsable, snapshotColaborador] = await Promise.all([
                            getDocs(qResponsable),
                            getDocs(qColaborador)
                        ]);
                        
                        const allTickets = new Map();
                        snapshotResponsable.forEach(doc => { allTickets.set(doc.id, doc); });
                        snapshotColaborador.forEach(doc => { allTickets.set(doc.id, doc); });
                        
                        querySnapshot = {
                            docs: Array.from(allTickets.values()),
                            empty: allTickets.size === 0,
                            size: allTickets.size,
                            forEach: function(callback) { this.docs.forEach(doc => callback(doc)); }
                        };
                    } else {
                        throw error;
                    }
                }
                
                const tickets = this.processTickets(querySnapshot);
                const ticketsEnriquecidos = await this.enriquecerTicketsConColaborador(tickets);
                
                AppState.allTickets = ticketsEnriquecidos;
                this.renderTickets(ticketsEnriquecidos);
                
                if (tickets.length > 0) {
                    AppState.lastCheckedTicketId = tickets[0].id;
                }
                
            } catch (error) {
                console.error("Error cargando tickets:", error);
                Utils.showError("No se pudieron cargar los tickets. " + error.message);
                DOM.ticketsContainer.innerHTML = `
                    <div class="no-tickets">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar tickets</h3>
                        <p>No se pudieron cargar los tickets: ${error.message}</p>
                    </div>
                `;
                // Simular cierre de sesión si falla la carga crítica
                if (error.message.includes('autenticado') || error.message.includes('colaborador')) {
                    window.location.replace('/vista/nav-visitantes/inicio-de-sesion.html');
                }
            } finally {
                Utils.hideLoading();
            }
        },

        async enriquecerTicketsConColaborador(tickets) {
            if (!tickets || tickets.length === 0 || !AppState.userData) return tickets;
            
            // Ya que el menú autónomo carga el perfil, solo retornamos los datos conocidos.
            const datosColaborador = AppState.userData;
                
            return tickets.map(ticket => ({
                ...ticket,
                colaborador: {
                    nombre: datosColaborador.NOMBRE,
                    area: datosColaborador.ÁREA,
                    puesto: datosColaborador.PUESTO,
                    imagen: datosColaborador.imagen || null
                }
            }));
        },

        async showTicketDetails(ticketId) {
            try {
                Utils.showLoading('Cargando detalles...');
                
                const ticketRef = doc(db, 'ticketsmesa', ticketId);
                const ticketSnap = await getDoc(ticketRef);
                
                if (!ticketSnap.exists()) {
                    throw new Error('El ticket no existe');
                }
                
                const data = ticketSnap.data();
                const shortId = ticketId.substring(0, 8);
                
                ticketManager.setCurrentTicket(ticketId, data.estado);
                
                let nombresColaboradores = [];
                if (data.colaboradores && data.colaboradores.length > 0) {
                    const colaboradoresPromises = data.colaboradores.map(async colabId => {
                        const colabRef = doc(db, 'colaboradores', colabId);
                        const colabSnap = await getDoc(colabRef);
                        return colabSnap.exists() ? colabSnap.data().NOMBRE : 'Colaborador desconocido';
                    });
                    nombresColaboradores = await Promise.all(colaboradoresPromises);
                }
                
                const evidenciasRef = collection(db, 'evidenciatickets');
                const q = query(evidenciasRef, where("ticketId", "==", ticketId));
                const evidenciasSnap = await getDocs(q);
                
                const evidencias = [];
                evidenciasSnap.forEach(doc => {
                    evidencias.push(doc.data());
                });
                
                const finishBtn = document.getElementById('finishTicketBtn');
                const editBtn = document.getElementById('editFinishBtn');
                
                // NOTA: Se usa firebase.auth().currentUser.uid ya que AppState.userData puede no estar cargado al 100%
                const userUid = firebase.auth().currentUser ? firebase.auth().currentUser.uid : AppState.userData.colaboradorId;

                const userEvidence = evidencias.find(
                    ev => ev.colaboradorId === userUid
                );
                
                const ticketEstaFinalizado = data.estado === 'finalizado';
                const usuarioYaCompleto = !!userEvidence;

                if (ticketEstaFinalizado) {
                    finishBtn.style.display = 'none';
                    editBtn.style.display = 'none';
                } else if (usuarioYaCompleto) {
                    finishBtn.style.display = 'none';
                    editBtn.style.display = 'inline-flex';
                } else {
                    finishBtn.style.display = 'inline-flex';
                    editBtn.style.display = 'none';
                }
                
                if (finishBtn) {
                    finishBtn.href = `../editar-ticket/editar-ticket.html?ticketId=${ticketId}`;
                }
                
                if (editBtn && usuarioYaCompleto) {
                    editBtn.onclick = () => {
                        window.location.href = `../editar-ticket/editar-ticket.html?ticketId=${ticketId}&edit=true`;
                    };
                }
                
                const modal = document.getElementById('detailModal');
                const detailContent = document.getElementById('detailContent');
                
                let progressHTML = '';
                if (data.colaboradores && data.colaboradores.length > 1) {
                    progressHTML = `
                        <div class="detail-section">
                            <strong>Progreso de Colaboradores</strong>
                            <div class="progress-container">
                                ${data.colaboradores.map((colabId, index) => {
                                    const evidenciaColab = evidencias.find(ev => ev.colaboradorId === colabId);
                                    const completado = !!evidenciaColab;
                                    const nombreColab = nombresColaboradores[index] || 'Colaborador';
                                    
                                    return `
                                        <div class="progress-item">
                                            <span class="progress-name">${nombreColab}</span>
                                            <span class="progress-status ${completado ? 'completed' : 'pending'}">
                                                <i class="fas ${completado ? 'fa-check-circle' : 'fa-clock'}"></i>
                                                ${completado ? 'Completado' : 'Pendiente'}
                                            </span>
                                            ${completado ? `
                                                <button class="view-evidence-btn" data-colab-id="${colabId}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                let userEvidenceHTML = '';
                if (userEvidence) {
                    userEvidenceHTML = `
                        <div class="detail-section">
                            <strong>Mis Evidencias</strong>
                            <div class="description-text">${userEvidence.descripcion}</div>
                            <div class="evidence-grid">
                                ${userEvidence.imagenes.map(img => `
                                    <img src="${img}" class="evidence-img clickable-image" 
                                        alt="Mi evidencia" style="cursor: pointer; max-height: 150px;"
                                        onclick="openImageModal('${img}')">
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                let additionalInfoHTML = '';
                if (data.servicio || data.proyecto || data.ordenServicio || data.descripcionActividades) {
                    additionalInfoHTML = `
                        <div class="detail-section">
                            <strong>Información Adicional</strong>
                            ${data.servicio ? `<p><span class="detail-label">Servicio:</span> ${data.servicio}</p>` : ''}
                            ${data.proyecto ? `<p><span class="detail-label">Proyecto:</span> ${data.proyecto}</p>` : ''}
                            ${data.ordenServicio ? `<p><span class="detail-label">Orden de Servicio:</span> ${data.ordenServicio}</p>` : ''}
                            ${data.descripcionActividades ? `<p><span class="detail-label">Actividades:</span> ${data.descripcionActividades}</p>` : ''}
                        </div>
                    `;
                }
                
                let fiscalInfoHTML = '';
                if (data.rfc || data.direccionFiscal || data.cuenta) {
                    fiscalInfoHTML = `
                        <div class="detail-section">
                            <strong>Información Fiscal</strong>
                            ${data.rfc ? `<p><span class="detail-label">RFC:</span> ${data.rfc}</p>` : ''}
                            ${data.direccionFiscal ? `<p><span class="detail-label">Dirección Fiscal:</span> ${data.direccionFiscal}</p>` : ''}
                            ${data.cuenta ? `<p><span class="detail-label">Cuenta:</span> ${data.cuenta}</p>` : ''}
                        </div>
                    `;
                }
                
                let sistemasHTML = '';
                if (data.sistemas && Object.keys(data.sistemas).length > 0) {
                    sistemasHTML = `
                        <div class="detail-section">
                            <strong>Sistemas Relacionados</strong>
                            <ul>
                                ${Object.entries(data.sistemas).map(([key, value]) => `
                                    <li>${key}: ${value}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                detailContent.innerHTML = `
                    <div style="text-align: left;">
                        <div class="detail-section">
                            <strong>Información Básica</strong>
                            <p><span class="detail-label">ID:</span> #${shortId.toUpperCase()}</p>
                            <p><span class="detail-label">Título:</span> ${data.titulo}</p>
                            <p><span class="detail-label">Estado:</span> 
                                <span class="badge ${Utils.getBadgeClass(data.estado)}">
                                    <i class="fas ${Utils.getStatusIcon(data.estado)}"></i> ${data.estado.replace('_', ' ')}
                                </span>
                            </p>
                            <p><span class="detail-label">Prioridad:</span> 
                                <span class="badge badge-primary">
                                    <span class="priority-indicator ${Utils.getPriorityClass(data.prioridad)}"></span> 
                                    ${data.prioridad}
                                </span>
                            </p>
                            <p><span class="detail-label">Área:</span> 
                                <span class="badge badge-primary">
                                    <i class="fas fa-layer-group"></i> ${data.area || 'General'}
                                </span>
                            </p>
                            <p><span class="detail-label">Responsable:</span> ${data.responsableNombre}</p>
                            <p><span class="detail-label">Colaboradores:</span> ${nombresColaboradores.join(', ')}</p>
                            <p><span class="detail-label">Fecha creación:</span> ${Utils.formatDate(data.fechaCreacion)}</p>
                            ${data.fechaActualizacion ? `<p><span class="detail-label">Última actualización:</span> ${Utils.formatDate(data.fechaActualizacion)}</p>` : ''}
                            ${data.fechaFinalizacion ? `<p><span class="detail-label">Fecha finalización:</span> ${Utils.formatDate(data.fechaFinalizacion)}</p>` : ''}
                        </div>
                        
                        ${progressHTML}
                        
                        <div class="detail-section">
                            <strong>Descripción</strong>
                            <div class="description-text">${data.descripcionActividades}</div>
                        </div>
                        
                        ${additionalInfoHTML}
                        ${fiscalInfoHTML}
                        ${sistemasHTML}
                        ${userEvidenceHTML}
                    </div>
                `;
                
                document.querySelectorAll('.view-evidence-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const colabId = btn.dataset.colabId;
                        const evidencia = evidencias.find(ev => ev.colaboradorId === colabId);
                        if (evidencia) {
                            Swal.fire({
                                title: `Evidencias de ${evidencia.colaboradorNombre}`,
                                html: `
                                    <div style="text-align: left; margin-bottom: 20px;">
                                        <p><strong>Descripción:</strong></p>
                                        <div class="description-text">${evidencia.descripcion}</div>
                                    </div>
                                    <div class="evidence-grid">
                                        ${evidencia.imagenes.map(img => `
                                            <img src="${img}" class="evidence-img clickable-image" 
                                                alt="Evidencia" style="cursor: pointer; max-height: 300px;"
                                                onclick="openImageModal('${img}')">
                                        `).join('')}
                                    </div>
                                `,
                                width: '80%',
                                confirmButtonText: 'Cerrar',
                                
                                background: '#1e1e1e', // Se deja para que el script de colores lo sobrescriba
                                color: '#ffffff'
                            });
                        }
                    });
                });

                function openImageModal(imgSrc) {
                    Swal.fire({
                        imageUrl: imgSrc,
                        imageAlt: 'Evidencia en tamaño completo',
                        background: '#1e1e1e', // Se deja para que el script de colores lo sobrescriba
                        padding: '1em',
                        showConfirmButton: false,
                        width: 'auto',
                    });
                }

                document.querySelectorAll('.print-pdf-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const ticketId = btn.dataset.ticketId;
                        await TicketsController.generateTicketPDF(ticketId);
                    });
                });
                
                modal.style.display = 'block';
                
            } catch (error) {
                console.error("Error mostrando detalles:", error);
                Utils.showError("No se pudieron cargar los detalles del ticket");
            } finally {
                Utils.hideLoading();
            }
        },

        async generateTicketPDF(ticketId) {
            try {
                const ticketRef = doc(db, 'ticketsmesa', ticketId);
                const ticketSnap = await getDoc(ticketRef);
                
                if (!ticketSnap.exists()) {
                    throw new Error('El ticket no existe');
                }
                
                const ticketData = { id: ticketId, ...ticketSnap.data() };
                
                const evidenciasRef = collection(db, 'evidenciatickets');
                const q = query(evidenciasRef, where("ticketId", "==", ticketId));
                const evidenciasSnap = await getDocs(q);
                
                const evidencias = [];
                evidenciasSnap.forEach(doc => {
                    evidencias.push(doc.data());
                });
                
                await pdfGenerator.generateTicketPDF(ticketData, evidencias);
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                Utils.showError('No se pudo generar el PDF: ' + error.message);
            }
        },

        async checkForNewTickets() {
            try {
                if (!AppState.userData || !AppState.userData.nombreCompleto) return false;
                
                const ticketsRef = collection(db, 'ticketsmesa');
                const q = query(
                    ticketsRef,
                    where("responsableNombre", "==", AppState.userData.nombreCompleto),
                    where("notificacion", "==", false),
                    orderBy("fechaCreacion", "desc"),
                    limit(1)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const latestTicket = querySnapshot.docs[0];
                    const ticketId = latestTicket.id;
                    const ticketRef = doc(db, 'ticketsmesa', ticketId);
                    const ticketData = latestTicket.data();
                    
                    const notificationShown = await Utils.showNotification(
                        'Nuevo Ticket Asignado - RSI',
                        `Tienes un nuevo ticket: "${ticketData.titulo || 'Nuevo ticket sin título'}"`,
                        ticketId
                    );
                    
                    if (notificationShown) {
                        await updateDoc(ticketRef, {
                            notificacion: true
                        });
                        
                        AppState.lastCheckedTicketId = ticketId;
                        
                        await this.loadUserTickets();
                        
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error("Error verificando nuevos tickets:", error);
                return false;
            }
        },

        setupTicketCheckInterval() {
            if (AppState.ticketCheckInterval) {
                clearInterval(AppState.ticketCheckInterval);
            }
            
            const checkTickets = async () => {
                const hadNewTickets = await this.checkForNewTickets();
                
                if (hadNewTickets) {
                    clearInterval(AppState.ticketCheckInterval);
                    AppState.notificationCheckInterval = 30000;
                    AppState.ticketCheckInterval = setInterval(checkTickets, AppState.notificationCheckInterval);
                } else {
                    if (AppState.notificationCheckInterval !== 10000) {
                        clearInterval(AppState.ticketCheckInterval);
                        AppState.notificationCheckInterval = 10000;
                        AppState.ticketCheckInterval = setInterval(checkTickets, AppState.notificationCheckInterval);
                    }
                }
            };
            
            AppState.ticketCheckInterval = setInterval(checkTickets, AppState.notificationCheckInterval);
        }
    };
    
    // ** LÓGICA DE INICIO DE LA APLICACIÓN (AJUSTADA PARA USAR AUTHENTICATION REAL) **
    async function initializeAppLogic() {
        console.log('Inicializando lógica de la aplicación...');

        // Escuchar el estado de autenticación (v8)
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                console.log('👤 Usuario autenticado detectado en TicketsController:', user.email);
                // Intenta cargar los datos del usuario y los tickets
                await TicketsController.loadUserTickets();
                TicketsController.setupTicketCheckInterval();
            } else {
                console.log('🚫 No hay usuario autenticado. Redirigiendo...');
                // Simular cierre de sesión
                document.getElementById('mensajeAcceso').style.display = 'block';
                document.getElementById('mensajeAcceso').innerHTML = `<div style="color: red; padding: 20px; text-align: center;">Acceso denegado. Redirigiendo...</div>`;
                setTimeout(() => {
                    window.location.replace('/vista/nav-visitantes/inicio-de-sesion.html');
                }, 3000);
            }
        });
    }


    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM cargado, configurando listeners...');
        
        // Configurar el filtro de tickets
        if (DOM.filterBtn) {
            DOM.filterBtn.addEventListener('click', () => {
                const showFinalized = ticketManager.toggleFilter();
                if (DOM.filterText) {
                    DOM.filterText.textContent = showFinalized ? 'Ver Activos' : 'Ver Finalizados';
                }
                
                if (AppState.allTickets.length > 0) {
                    TicketsController.renderTickets(AppState.allTickets);
                }
            });
        }
        
        // Configurar todos los botones de cerrar
        const closeButtons = document.querySelectorAll('.modal .close, .cancel-btn, #closeDetailBtn');
        closeButtons.forEach(btn => {
            btn.addEventListener('click', closeModals);
        });
        
        // ** INICIAR LA LÓGICA DE LA APLICACIÓN **
        initializeAppLogic();
        
        // Hacer Swal disponible globalmente
        window.Swal = Swal;

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../../sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado:', registration.scope);
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data && event.data.action === 'view') {
                                TicketsController.showTicketDetails(event.data.ticketId);
                            }
                        });
                    })
                    .catch(error => {
                        console.log('Error al registrar ServiceWorker:', error);
                    });
            });
        }
    });

    function closeModals(e) {
        if (e) e.preventDefault();
        
        const modals = ['detailModal', 'imageViewerModal', 'pdfProgressModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        });
        
        ticketManager.clearCurrentTicket();
    }

    window.openImageModal = function(imageSrc) {
        const modal = document.getElementById('imageViewerModal');
        const img = document.getElementById('expandedImage');
        if (modal && img) {
            img.src = imageSrc;
            modal.style.display = 'block';
        }
    };

    function closeImageModal() {
        const modal = document.getElementById('imageViewerModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    const imageModalClose = document.querySelector('#imageViewerModal .close');
    if (imageModalClose) {
        imageModalClose.addEventListener('click', closeImageModal);
    }

    const imageViewerModal = document.getElementById('imageViewerModal');
    if (imageViewerModal) {
        imageViewerModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
    }

    async function updateTicketStatus(ticketId, newStatus) {
        try {
            Utils.showLoading('Actualizando estado...');
            
            const ticketRef = doc(db, 'ticketsmesa', ticketId);
            
            await updateDoc(ticketRef, {
                estado: newStatus,
                fechaActualizacion: serverTimestamp()
            });
            
            if (newStatus === 'cerrado') {
                await updateDoc(ticketRef, {
                    fechaFinalizacion: serverTimestamp()
                });
            }
            
            Utils.hideLoading();
            
            Swal.fire({
                icon: 'success',
                title: 'Estado actualizado',
                text: `El estado del ticket ha sido cambiado a ${newStatus.replace(/_/g, ' ')}`,
                confirmButtonColor: '#3085d6'
            });
            
            if (document.getElementById('detailModal').style.display === 'block') {
                await TicketsController.showTicketDetails(ticketId);
            }
            
            await TicketsController.loadUserTickets();
            
        } catch (error) {
            console.error("Error actualizando estado:", error);
            Utils.showError('No se pudo actualizar el estado del ticket');
        }
    }

    const originalShowTicketDetails = TicketsController.showTicketDetails;
    TicketsController.showTicketDetails = async function(ticketId) {
        await originalShowTicketDetails.call(this, ticketId);
        
        const modalContent = document.getElementById('detailContent');
        const statusControl = document.createElement('div');
        statusControl.className = 'status-control-container';
        statusControl.style.cssText = `
            /* Los estilos se aplicarán mediante CSS global/variables */
        `;
        
        const ticketRef = doc(db, 'ticketsmesa', ticketId);
        const ticketSnap = await getDoc(ticketRef);
        const ticketData = ticketSnap.data();
        let currentStatus = ticketData.estado || 'pendiente_de_aceptación';
        let pauseComment = ticketData.pauseComment || '';
        
        const statusInfoContainer = document.createElement('div');
        statusInfoContainer.className = 'status-info-container';

        // Estilos limpios
        const statusBadge = document.createElement('span');
        statusBadge.className = `current-status-badge ${currentStatus}`;
        statusBadge.textContent = currentStatus.replace(/_/g, ' ');
        statusBadge.style.backgroundColor = getStatusColor(currentStatus);
        statusBadge.style.color = currentStatus === 'pendiente_de_aceptación' ? '#000' : '#fff';

        statusInfoContainer.appendChild(statusBadge);
        
        if (currentStatus === 'en_proceso' && pauseComment) {
            // El elemento se crea sin estilos inline para que el CSS externo lo maneje
            const commentBadge = document.createElement('div');
            commentBadge.className = 'pause-comment-badge';
            commentBadge.innerHTML = `
                <div class="pause-comment-content">
                    <strong class="pause-comment-label">Razón de pausa:</strong>
                    <p class="pause-comment-text">${pauseComment}</p>
                    <div class="pause-comment-word-count"></div>
                </div>
            `;
            statusInfoContainer.appendChild(commentBadge);
        }
        
        statusControl.appendChild(statusInfoContainer);
        
        const statusSelect = document.createElement('select');
        statusSelect.className = 'status-select';
        
        const statusOptions = [
            { value: 'pendiente_de_aceptación', text: 'Pendiente de aceptación' },
            { value: 'aceptado', text: 'Aceptado' },
            { value: 'en_proceso', text: 'En pausa' },
            { value: 'en_camino', text: 'En camino' },
            { value: 'completado', text: 'Completado' },
            { value: 'cerrado', text: 'Cerrado' }
        ];
        
        statusOptions.forEach(option => {
            const optElement = document.createElement('option');
            optElement.value = option.value;
            optElement.textContent = option.text;
            optElement.selected = option.value === currentStatus;
            statusSelect.appendChild(optElement);
        });
        
        statusControl.appendChild(statusSelect);
        
        const saveButton = document.createElement('button');
        saveButton.className = 'save-status-btn btn-primary';
        saveButton.innerHTML = '<i class="fas fa-save"></i> Guardar Estado';
        
        saveButton.onclick = async () => {
            const newStatus = statusSelect.value;
            let comment = pauseComment;
            
            if (newStatus === 'en_proceso') {
                const { value: commentText } = await Swal.fire({
                    title: 'Razón de la pausa',
                    html: `
                        <textarea id="commentTextarea" class="swal2-textarea"
                                         placeholder="Escribe aquí la razón (máximo 200 palabras)...">${pauseComment}</textarea>
                        <div id="wordCounter" class="swal2-word-counter">0/200 palabras</div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    cancelButtonText: 'Cancelar',
                    preConfirm: () => {
                        const textarea = document.getElementById('commentTextarea');
                        const text = textarea.value.trim();
                        const wordCount = text.split(/\s+/).length;
                        
                        if (!text) {
                            Swal.showValidationMessage('Debes escribir una razón para la pausa');
                            return false;
                        }
                        if (wordCount > 200) {
                            Swal.showValidationMessage(`Has excedido el límite de 200 palabras (${wordCount})`);
                            return false;
                        }
                        return text;
                    },
                    didOpen: () => {
                        const textarea = document.getElementById('commentTextarea');
                        const counter = document.getElementById('wordCounter');
                        
                        textarea.addEventListener('input', () => {
                            const text = textarea.value.trim();
                            const wordCount = text ? text.split(/\s+/).length : 0;
                            counter.textContent = `${wordCount}/200 palabras`;
                        });
                        
                        const initialWordCount = pauseComment ? pauseComment.trim().split(/\s+/).length : 0;
                        counter.textContent = `${initialWordCount}/200 palabras`;
                    }
                });
                
                if (commentText === undefined) return;
                comment = commentText;
            }
            
            try {
                const updateData = {
                    estado: newStatus,
                    updatedAt: serverTimestamp(),
                    ...(newStatus === 'en_proceso' ? { pauseComment: comment } : { pauseComment: '' })
                };
                
                await updateDoc(ticketRef, updateData);
                
                currentStatus = newStatus;
                pauseComment = newStatus === 'en_proceso' ? comment : '';
                
                // Actualizar estilos sin estilos inline fijos, usando la función auxiliar
                statusBadge.className = `current-status-badge ${newStatus}`;
                statusBadge.textContent = newStatus.replace(/_/g, ' ');
                statusBadge.style.backgroundColor = getStatusColor(newStatus);
                statusBadge.style.color = newStatus === 'pendiente_de_aceptación' ? '#000' : '#fff';
                
                const existingComment = statusInfoContainer.querySelector('.pause-comment-badge');
                if (existingComment) existingComment.remove();
                
                if (newStatus === 'en_proceso' && comment) {
                    const commentBadge = document.createElement('div');
                    commentBadge.className = 'pause-comment-badge';
                    commentBadge.innerHTML = `
                        <div class="pause-comment-content">
                            <strong class="pause-comment-label">Razón de pausa:</strong>
                            <p class="pause-comment-text">${comment}</p>
                            <div class="pause-comment-word-count">${comment.trim().split(/\s+/).length}/200 palabras</div>
                        </div>
                    `;
                    statusInfoContainer.appendChild(commentBadge);
                }
                
                await Swal.fire({
                    icon: 'success',
                    title: '¡Actualizado!',
                    text: 'El estado del ticket ha sido actualizado',
                    timer: 1500,
                    showConfirmButton: false,
                    // Se deja sin estilos para que el script de colores los aplique
                });
                
            } catch (error) {
                console.error("Error updating ticket: ", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo actualizar el ticket: ' + error.message,
                    // Se deja sin estilos para que el script de colores los aplique
                });
            }
        };
        
        statusControl.appendChild(saveButton);
        modalContent.insertBefore(statusControl, modalContent.firstChild);
    };

    function getStatusColor(status) {
        const colors = {
            'pendiente_de_aceptación': '#ffc107',
            'aceptado': '#17a2b8',
            'en_proceso': '#fd7e14',
            'en_camino': '#007bff',
            'completado': '#28a745',
            'cerrado': '#6c757d'
        };
        return colors[status] || '#6c757d';
    }
    </script>
    <script>
    // Se elimina la lógica del menú de hamburguesa que estaba aquí.
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="../js/navegacion-admin.js"></script>
    <script src="../js/personalizacion-colores.js"></script>
</body>
</html>