<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSI Enterprise - Sistema de Notas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="gestion-tickets-admin.css">
    <style>
        /* ESTILOS ESPECÍFICOS PARA EL SISTEMA DE NOTAS */
        .notes-container {
            padding: 25px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .notes-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .notes-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }

        .notes-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-color);
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .notes-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .notes-content {
            display: none;
        }

        .notes-content.active {
            display: block;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .note-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .note-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            flex: 1;
            margin-right: 10px;
        }

        .note-actions {
            display: flex;
            gap: 8px;
        }

        .note-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s ease;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .note-action-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .note-action-btn.delete:hover {
            background: #e74c3c;
        }

        .note-content {
            flex: 1;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .note-checklist {
            margin-top: 10px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.3s ease;
        }

        .checklist-item:hover {
            background: rgba(0,0,0,0.03);
        }

        .checklist-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checklist-item label {
            flex: 1;
            cursor: pointer;
        }

        .checklist-item.completed label {
            text-decoration: line-through;
            color: rgba(0,0,0,0.5);
        }

        .note-meta {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
            font-size: 0.8rem;
            color: rgba(0,0,0,0.6);
        }

        .note-creator, .note-completer {
            margin-bottom: 5px;
        }

        .note-date {
            font-style: italic;
        }

        .empty-notes {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-color);
        }

        .empty-notes i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            opacity: 0.7;
        }

        .empty-notes h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .empty-notes p {
            font-size: 1rem;
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* FORMULARIO DE NUEVA NOTA */
        .note-form-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }

        .note-form-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(108, 67, 224, 0.2);
        }

        .checklist-items-container {
            margin-top: 10px;
        }

        .checklist-item-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checklist-item-input input {
            flex: 1;
            margin-right: 10px;
        }

        .remove-checklist-item {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .remove-checklist-item:hover {
            background: rgba(231, 76, 60, 0.1);
        }

        .add-checklist-item {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .add-checklist-item:hover {
            background: rgba(108, 67, 224, 0.1);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            border: 2px solid;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            border-color: rgba(0,0,0,0.2);
        }

        .btn-secondary:hover {
            background: rgba(0,0,0,0.05);
        }

        .btn-success {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .btn-success:hover {
            background: #218838;
            border-color: #218838;
            transform: translateY(-2px);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .notes-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .notes-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .notes-tabs {
                width: 100%;
                overflow-x: auto;
            }

            .notes-grid {
                grid-template-columns: 1fr;
            }

            .note-form-container {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .notes-container {
                padding: 15px;
            }

            .note-card {
                padding: 15px;
            }

            .note-form-container {
                padding: 15px;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- El menú lateral será cargado dinámicamente por navegacion-admin.js -->
    
    <div class="main-c">
        <div class="header">
            <!-- El botón de menú será cargado por navegacion-admin.js -->
            <div class="header-title-container">
                <center><h2 class="title"">Sistema de Notas</h2></center>
            </div>
        </div>

        <div class="notes-container">
            <div class="notes-header">
                <h2>Mis Notas</h2>
                <div class="notes-actions">
                    <button class="btn btn-success" id="newGeneralNoteBtn">
                        <i class="fas fa-users"></i>
                        Nota General
                    </button>
                    <button class="btn btn-primary" id="newPersonalNoteBtn">
                        <i class="fas fa-user"></i>
                        Nota Personal
                    </button>
                </div>
            </div>

            <div class="notes-tabs">
                <button class="notes-tab active" data-tab="general">Notas Generales</button>
                <button class="notes-tab" data-tab="personal">Notas Personales</button>
            </div>

            <!-- Formulario para nueva nota (oculto inicialmente) -->
            <div class="note-form-container" id="noteFormContainer" style="display: none;">
                <h3 class="note-form-title" id="noteFormTitle">Nueva Nota</h3>
                <form id="noteForm">
                    <input type="hidden" id="noteId">
                    <input type="hidden" id="noteType">
                    
                    <div class="form-group">
                        <label for="noteTitle" class="form-label">Título</label>
                        <input type="text" id="noteTitle" class="form-control" placeholder="Título de la nota" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="noteContent" class="form-label">Contenido</label>
                        <textarea id="noteContent" class="form-control" rows="3" placeholder="Descripción de la nota"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Checklist</label>
                        <div class="checklist-items-container" id="checklistItemsContainer">
                            <!-- Los items del checklist se agregarán aquí dinámicamente -->
                        </div>
                        <button type="button" class="add-checklist-item" id="addChecklistItem">
                            <i class="fas fa-plus"></i>
                            Agregar elemento al checklist
                        </button>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelNoteBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="saveNoteBtn">Guardar Nota</button>
                    </div>
                </form>
            </div>

            <!-- Contenido de notas generales -->
            <div class="notes-content active" id="generalNotesContent">
                <div class="notes-grid" id="generalNotesGrid">
                    <!-- Las notas generales se cargarán aquí -->
                </div>
            </div>

            <!-- Contenido de notas personales -->
            <div class="notes-content" id="personalNotesContent">
                <div class="notes-grid" id="personalNotesGrid">
                    <!-- Las notas personales se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
            authDomain: "rsienterprise.firebaseapp.com",
            projectId: "rsienterprise",
            storageBucket: "rsienterprise.appspot.com",
            messagingSenderId: "1063117165770",
            appId: "1:1063117165770:web:8555f26b25ae80bc42d033"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Estado de la aplicación
        const appState = {
            currentUser: null,
            userData: null,
            currentTab: 'general',
            notes: {
                general: [],
                personal: []
            },
            editingNote: null
        };

        // =================================================================================
        // FUNCIONES PRINCIPALES
        // =================================================================================

        async function initialLoad() {
            try {
                await loadUserProfile();
                setupEventListeners();
                loadNotes();
            } catch (error) {
                console.error("Error en la carga inicial:", error);
                showError('No se pudieron cargar los datos iniciales.');
            }
        }

        async function loadUserProfile() {
            const user = auth.currentUser;
            if (!user) {
                window.location.href = '../nav-visitantes/inicio-de-sesion.html';
                return;
            }
            
            try {
                const querySnapshot = await db.collection("colaboradores")
                    .where("CORREO ELECTRÓNICO EMPRESARIAL", "==", user.email)
                    .get();
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const userData = doc.data();
                    appState.currentUser = {
                        id: doc.id,
                        nombre: userData.NOMBRE,
                        area: userData.ÁREA,
                        imagen: userData.imagen || '../css/img/Logo-RSI-OFICIAL.png'
                    };
                    appState.userData = appState.currentUser;
                    sessionStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
                }
            } catch (error) {
                console.error("Error al cargar perfil:", error);
            }
        }

        async function loadNotes() {
            try {
                // Cargar notas generales
                const generalSnapshot = await db.collection('notasGenerales')
                    .orderBy('fechaCreacion', 'desc')
                    .get();
                
                appState.notes.general = generalSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        fechaCreacion: data.fechaCreacion ? data.fechaCreacion.toDate() : new Date(),
                        fechaCompletado: data.fechaCompletado ? data.fechaCompletado.toDate() : null
                    };
                });

                // Cargar notas personales - CONSULTA SIMPLIFICADA PARA EVITAR ERROR DE ÍNDICE
                if (appState.currentUser) {
                    const personalSnapshot = await db.collection('notasPersonales')
                        .where('usuarioId', '==', appState.currentUser.id)
                        .get();
                    
                    appState.notes.personal = personalSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            fechaCreacion: data.fechaCreacion ? data.fechaCreacion.toDate() : new Date(),
                            fechaCompletado: data.fechaCompletado ? data.fechaCompletado.toDate() : null
                        };
                    }).sort((a, b) => b.fechaCreacion - a.fechaCreacion); // Ordenar por fecha en el cliente
                }

                displayNotes();
            } catch (error) {
                console.error("Error al cargar notas:", error);
                showError('No se pudieron cargar las notas. ' + error.message);
            }
        }

        function displayNotes() {
            displayGeneralNotes();
            displayPersonalNotes();
        }

        function displayGeneralNotes() {
            const container = document.getElementById('generalNotesGrid');
            
            if (!appState.notes.general || appState.notes.general.length === 0) {
                container.innerHTML = `
                    <div class="empty-notes">
                        <i class="fas fa-sticky-note"></i>
                        <h3>No hay notas generales</h3>
                        <p>Las notas generales son visibles para todos los usuarios.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = appState.notes.general.map(note => `
                <div class="note-card" data-id="${note.id}">
                    <div class="note-header">
                        <h3 class="note-title">${note.titulo || 'Sin título'}</h3>
                        <div class="note-actions">
                            ${note.creadorId === appState.currentUser.id ? `
                                <button class="note-action-btn edit" title="Editar nota">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="note-action-btn delete" title="Eliminar nota">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="note-content">
                        ${note.contenido ? `<p>${note.contenido}</p>` : ''}
                        
                        ${note.checklist && note.checklist.length > 0 ? `
                            <div class="note-checklist">
                                ${note.checklist.map((item, index) => `
                                    <div class="checklist-item ${item.completado ? 'completed' : ''}">
                                        <input type="checkbox" ${item.completado ? 'checked' : ''} 
                                               data-note-id="${note.id}" data-item-index="${index}" 
                                               ${note.creadorId !== appState.currentUser.id && note.completadoPor ? 'disabled' : ''}>
                                        <label>${item.texto}</label>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="note-meta">
                        <div class="note-creator">
                            <strong>Creada por:</strong> ${note.creadorNombre || 'Usuario desconocido'}
                        </div>
                        <div class="note-date">
                            <strong>Fecha:</strong> ${formatDateTime(note.fechaCreacion)}
                        </div>
                        ${note.completadoPor ? `
                            <div class="note-completer">
                                <strong>Completada por:</strong> ${note.completadoPorNombre || 'Usuario desconocido'}
                            </div>
                            <div class="note-date">
                                <strong>Fecha de completado:</strong> ${formatDateTime(note.fechaCompletado)}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Agregar event listeners para checkboxes
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleChecklistChange);
            });

            // Agregar event listeners para botones de acción
            container.querySelectorAll('.note-action-btn.edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const noteId = this.closest('.note-card').dataset.id;
                    editNote(noteId, 'general');
                });
            });

            container.querySelectorAll('.note-action-btn.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const noteId = this.closest('.note-card').dataset.id;
                    deleteNote(noteId, 'general');
                });
            });
        }

        function displayPersonalNotes() {
            const container = document.getElementById('personalNotesGrid');
            
            if (!appState.notes.personal || appState.notes.personal.length === 0) {
                container.innerHTML = `
                    <div class="empty-notes">
                        <i class="fas fa-sticky-note"></i>
                        <h3>No hay notas personales</h3>
                        <p>Crea notas personales que solo tú puedes ver.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = appState.notes.personal.map(note => `
                <div class="note-card" data-id="${note.id}">
                    <div class="note-header">
                        <h3 class="note-title">${note.titulo || 'Sin título'}</h3>
                        <div class="note-actions">
                            <button class="note-action-btn edit" title="Editar nota">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="note-action-btn delete" title="Eliminar nota">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="note-content">
                        ${note.contenido ? `<p>${note.contenido}</p>` : ''}
                        
                        ${note.checklist && note.checklist.length > 0 ? `
                            <div class="note-checklist">
                                ${note.checklist.map((item, index) => `
                                    <div class="checklist-item ${item.completado ? 'completed' : ''}">
                                        <input type="checkbox" ${item.completado ? 'checked' : ''} 
                                               data-note-id="${note.id}" data-item-index="${index}">
                                        <label>${item.texto}</label>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="note-meta">
                        <div class="note-date">
                            <strong>Fecha:</strong> ${formatDateTime(note.fechaCreacion)}
                        </div>
                        ${note.completado ? `
                            <div class="note-date">
                                <strong>Completada:</strong> ${formatDateTime(note.fechaCompletado)}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Agregar event listeners para checkboxes
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleChecklistChange);
            });

            // Agregar event listeners para botones de acción
            container.querySelectorAll('.note-action-btn.edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const noteId = this.closest('.note-card').dataset.id;
                    editNote(noteId, 'personal');
                });
            });

            container.querySelectorAll('.note-action-btn.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const noteId = this.closest('.note-card').dataset.id;
                    deleteNote(noteId, 'personal');
                });
            });
        }

        // =================================================================================
        // FUNCIONES DE GESTIÓN DE NOTAS
        // =================================================================================

        function showNoteForm(type = null, note = null) {
            const formContainer = document.getElementById('noteFormContainer');
            const formTitle = document.getElementById('noteFormTitle');
            
            // Limpiar formulario
            document.getElementById('noteForm').reset();
            document.getElementById('checklistItemsContainer').innerHTML = '';
            
            if (note) {
                // Modo edición
                formTitle.textContent = 'Editar Nota';
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteType').value = type;
                document.getElementById('noteTitle').value = note.titulo || '';
                document.getElementById('noteContent').value = note.contenido || '';
                
                // Agregar items del checklist
                if (note.checklist && note.checklist.length > 0) {
                    note.checklist.forEach(item => {
                        addChecklistItemToForm(item.texto);
                    });
                }
                
                appState.editingNote = note;
            } else {
                // Modo creación
                formTitle.textContent = type === 'general' ? 'Nueva Nota General' : 'Nueva Nota Personal';
                document.getElementById('noteId').value = '';
                document.getElementById('noteType').value = type;
                appState.editingNote = null;
                
                // Agregar un item vacío por defecto
                addChecklistItemToForm();
            }
            
            formContainer.style.display = 'block';
            document.getElementById('noteTitle').focus();
        }

        function hideNoteForm() {
            document.getElementById('noteFormContainer').style.display = 'none';
            appState.editingNote = null;
        }

        function addChecklistItemToForm(text = '') {
            const container = document.getElementById('checklistItemsContainer');
            const itemId = 'checklist-item-' + Date.now();
            
            const itemHtml = `
                <div class="checklist-item-input" id="${itemId}">
                    <input type="text" class="form-control" placeholder="Elemento del checklist" value="${text}" required>
                    <button type="button" class="remove-checklist-item" data-item-id="${itemId}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHtml);
            
            // Agregar event listener al botón de eliminar
            document.querySelector(`[data-item-id="${itemId}"]`).addEventListener('click', function() {
                document.getElementById(itemId).remove();
            });
        }

        async function saveNote(formData) {
            try {
                const noteData = {
                    titulo: formData.titulo,
                    contenido: formData.contenido,
                    checklist: formData.checklistItems.map(item => ({
                        texto: item,
                        completado: false
                    })),
                    fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (formData.id) {
                    // Actualizar nota existente
                    if (formData.type === 'general') {
                        await db.collection('notasGenerales').doc(formData.id).update(noteData);
                    } else {
                        await db.collection('notasPersonales').doc(formData.id).update(noteData);
                    }
                    
                    showSuccess('Nota actualizada correctamente.');
                } else {
                    // Crear nueva nota
                    const baseData = {
                        ...noteData,
                        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
                        completado: false
                    };

                    if (formData.type === 'general') {
                        await db.collection('notasGenerales').add({
                            ...baseData,
                            creadorId: appState.currentUser.id,
                            creadorNombre: appState.currentUser.nombre
                        });
                    } else {
                        await db.collection('notasPersonales').add({
                            ...baseData,
                            usuarioId: appState.currentUser.id
                        });
                    }
                    
                    showSuccess('Nota creada correctamente.');
                }
                
                hideNoteForm();
                loadNotes();
            } catch (error) {
                console.error("Error al guardar nota:", error);
                showError('No se pudo guardar la nota.');
            }
        }

        async function handleChecklistChange(event) {
            const checkbox = event.target;
            const noteId = checkbox.dataset.noteId;
            const itemIndex = parseInt(checkbox.dataset.itemIndex);
            const isChecked = checkbox.checked;
            
            try {
                // Determinar si es una nota general o personal
                let noteType = 'personal';
                let noteRef = db.collection('notasPersonales').doc(noteId);
                
                // Verificar si existe en notas generales
                const generalNote = await db.collection('notasGenerales').doc(noteId).get();
                if (generalNote.exists) {
                    noteType = 'general';
                    noteRef = db.collection('notasGenerales').doc(noteId);
                }
                
                // Actualizar el estado del item del checklist
                const noteDoc = await noteRef.get();
                const noteData = noteDoc.data();
                const updatedChecklist = [...noteData.checklist];
                updatedChecklist[itemIndex].completado = isChecked;
                
                // Verificar si todos los items están completados
                const allCompleted = updatedChecklist.every(item => item.completado);
                
                const updateData = {
                    checklist: updatedChecklist,
                    fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Si es una nota general y se completó, registrar quién la completó
                if (noteType === 'general' && allCompleted && !noteData.completado) {
                    updateData.completado = true;
                    updateData.completadoPor = appState.currentUser.id;
                    updateData.completadoPorNombre = appState.currentUser.nombre;
                    updateData.fechaCompletado = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                // Si es una nota personal y se completó
                if (noteType === 'personal' && allCompleted && !noteData.completado) {
                    updateData.completado = true;
                    updateData.fechaCompletado = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                // Si se desmarcó un item y la nota estaba completada
                if (!allCompleted && noteData.completado) {
                    updateData.completado = false;
                    updateData.completadoPor = null;
                    updateData.completadoPorNombre = null;
                    updateData.fechaCompletado = null;
                }
                
                await noteRef.update(updateData);
                loadNotes();
            } catch (error) {
                console.error("Error al actualizar checklist:", error);
                showError('No se pudo actualizar el checklist.');
                // Revertir el cambio visual
                checkbox.checked = !isChecked;
            }
        }

        async function editNote(noteId, type) {
            try {
                const noteRef = type === 'general' 
                    ? db.collection('notasGenerales').doc(noteId)
                    : db.collection('notasPersonales').doc(noteId);
                
                const noteDoc = await noteRef.get();
                
                if (noteDoc.exists) {
                    const noteData = noteDoc.data();
                    showNoteForm(type, {
                        id: noteId,
                        ...noteData
                    });
                } else {
                    showError('La nota no existe.');
                }
            } catch (error) {
                console.error("Error al cargar nota para editar:", error);
                showError('No se pudo cargar la nota para editar.');
            }
        }

        async function deleteNote(noteId, type) {
            try {
                const result = await Swal.fire({
                    title: '¿Eliminar nota?',
                    text: "Esta acción no se puede deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#6C43E0',
                    cancelButtonColor: '#dc3545'
                });

                if (result.isConfirmed) {
                    if (type === 'general') {
                        await db.collection('notasGenerales').doc(noteId).delete();
                    } else {
                        await db.collection('notasPersonales').doc(noteId).delete();
                    }
                    
                    showSuccess('Nota eliminada correctamente.');
                    loadNotes();
                }
            } catch (error) {
                console.error("Error al eliminar nota:", error);
                showError('No se pudo eliminar la nota.');
            }
        }

        // =================================================================================
        // FUNCIONES AUXILIARES
        // =================================================================================

        function formatDateTime(date) {
            if (!date) return 'N/A';
            
            try {
                const d = new Date(date);
                return d.toLocaleDateString('es-MX') + ' ' + d.toLocaleTimeString('es-MX', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Fecha inválida';
            }
        }

        function showError(message) {
            Swal.fire({
                title: 'Error',
                text: message,
                icon: 'error',
                confirmButtonColor: '#6C43E0'
            });
        }

        function showSuccess(message) {
            Swal.fire({
                title: '¡Éxito!',
                text: message,
                icon: 'success',
                confirmButtonColor: '#6C43E0'
            });
        }

        // =================================================================================
        // CONFIGURACIÓN DE EVENT LISTENERS
        // =================================================================================

        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.notes-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Actualizar tabs activos
                    document.querySelectorAll('.notes-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.notes-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}NotesContent`).classList.add('active');
                    
                    appState.currentTab = this.dataset.tab;
                });
            });

            // Botón nueva nota general
            document.getElementById('newGeneralNoteBtn').addEventListener('click', function() {
                showNoteForm('general');
            });

            // Botón nueva nota personal
            document.getElementById('newPersonalNoteBtn').addEventListener('click', function() {
                showNoteForm('personal');
            });

            // Botón agregar item al checklist
            document.getElementById('addChecklistItem').addEventListener('click', function() {
                addChecklistItemToForm();
            });

            // Botón cancelar
            document.getElementById('cancelNoteBtn').addEventListener('click', hideNoteForm);

            // Formulario de nota
            document.getElementById('noteForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    id: document.getElementById('noteId').value,
                    type: document.getElementById('noteType').value,
                    titulo: document.getElementById('noteTitle').value.trim(),
                    contenido: document.getElementById('noteContent').value.trim(),
                    checklistItems: []
                };
                
                // Obtener items del checklist
                const checklistInputs = document.querySelectorAll('#checklistItemsContainer input');
                checklistInputs.forEach(input => {
                    if (input.value.trim()) {
                        formData.checklistItems.push(input.value.trim());
                    }
                });
                
                if (!formData.titulo) {
                    showError('El título es obligatorio.');
                    return;
                }
                
                saveNote(formData);
            });
        }

        // =================================================================================
        // INICIALIZACIÓN
        // =================================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            auth.onAuthStateChanged((user) => {
                if (user) {
                    initialLoad();
                } else {
                    window.location.href = '../nav-visitantes/inicio-de-sesion.html';
                }
            });
        });
    </script>
    <script src="../js/personalizacion-colores.js"></script>
    <script src="../js/navegacion-admin.js"></script>
</body>
</html>