<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toma de Asistencias</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
    <div class="attendance-container" id="attendanceContainer">
        <div class="attendance-header">
            <h1>Toma de Asistencias</h1>
            <p>Registra tu estatus laboral para el día de hoy</p>
        </div>

        <div class="employee-info">
            <img src="imgaqui" alt="Empleado" class="employee-avatar" id="employeeAvatar">
            <div class="employee-details">
                <h3></h3>
                <p>Departamento: Desarrollo</p>
                <p>ID: EMP-2023-0456</p>
            </div>
        </div>

        <div class="attendance-options">
            <div class="attendance-date" id="attendanceDate">
                <i class="fas fa-calendar-day"></i> <span id="currentDate"></span>
            </div>

            <div class="options-grid">
                <div class="attendance-option" data-value="office">
                    <div class="checkbox"></div>
                    <div class="option-icon"><i class="fas fa-building"></i></div>
                    <div class="option-label">En oficina</div>
                    <div class="option-desc">Asistencia presencial en oficina principal</div>
                </div>

                <div class="attendance-option" data-value="site">
                    <div class="checkbox"></div>
                    <div class="option-icon"><i class="fas fa-map-marker-alt"></i></div>
                    <div class="option-label">En sitio</div>
                    <div class="option-desc">Trabajando en ubicación del cliente</div>
                </div>

                <div class="attendance-option" data-value="iztapaluca">
                    <div class="checkbox"></div>
                    <div class="option-icon"><i class="fas fa-building"></i></div>
                    <div class="option-label">En oficina de Ixtapaluca</div>
                    <div class="option-desc">Trabajando en oficina de Ixtapaluca</div>
                </div>

                <div class="attendance-option" data-value="sick">
                    <div class="checkbox"></div>
                    <div class="option-icon"><i class="fas fa-procedures"></i></div>
                    <div class="option-label">Incapacidad</div>
                    <div class="option-desc">Ausencia por enfermedad/incapacidad</div>
                </div>
            </div>
        </div>

        <button class="submit-btn" id="submitAttendance">
            <i class="fas fa-check-circle"></i> Registrar Asistencia
        </button>
    </div>

    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-box">
            <div class="alert-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="alert-title">¡Asistencia registrada!</h3>
            <p class="alert-message">Tu asistencia ha sido registrada correctamente para el día de hoy.</p>
            <button class="alert-btn" id="alertBtn">Aceptar</button>
        </div>
    </div>

    <!-- Alerta de error -->
    <div class="alert-overlay" id="errorAlert">
        <div class="alert-box error-alert-box">
            <div class="alert-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h3 class="alert-title">¡Selecciona una opción!</h3>
            <p class="alert-message">Debes seleccionar un tipo de asistencia antes de continuar.</p>
            <button class="alert-btn" id="errorBtn">Entendido</button>
        </div>
    </div>

<div class="alert-overlay" id="locationOverlay">
    <div class="alert-box">
        <div class="alert-icon">
            <i class="fas fa-map-marker-alt"></i> <!-- Icono apropiado -->
        </div>
        <h3 class="alert-title">Ubicación requerida</h3>
        <p class="alert-message">Para registrar tu asistencia, necesitamos acceder a tu ubicación actual. Por favor, permite el acceso a la geolocalización.</p>
        <button class="alert-btn" id="locationBtn">Permitir ubicación</button>
    </div>
</div>


    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script>

document.addEventListener('DOMContentLoaded', function() {
    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
        authDomain: "rsienterprise.firebaseapp.com",
        databaseURL: "https://rsienterprise-default-rtdb.firebaseio.com",
        projectId: "rsienterprise",
        storageBucket: "rsienterprise.appspot.com",
        messagingSenderId: "1063117165770",
        appId: "1:1063117165770:web:8555f26b25ae80bc42d033",
        measurementId: "G-38F2DBG9HE"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // Elementos del DOM
    const attendanceContainer = document.getElementById('attendanceContainer');
    const employeeAvatar = document.getElementById('employeeAvatar');
    const employeeDetails = document.querySelector('.employee-details');
    const currentDateElement = document.getElementById('currentDate');
    const attendanceOptions = document.querySelectorAll('.attendance-option');
    const submitBtn = document.getElementById('submitAttendance');
    const optionsGrid = document.querySelector('.options-grid');
    const alertOverlay = document.getElementById('alertOverlay');
    const alertBtn = document.getElementById('alertBtn');
    const errorAlert = document.getElementById('errorAlert');
    const errorBtn = document.getElementById('errorBtn');
    const alertTitle = document.querySelector('.alert-title');
    const alertMessage = document.querySelector('.alert-message');
    const locationOverlay = document.getElementById('locationOverlay');
    const locationBtn = document.getElementById('locationBtn');

    
        // Función para obtener el rol del usuario desde la colección 'usuarios'
async function getUserRole(email) {
    try {
        const querySnapshot = await db.collection('usuarios')
            .where('email', '==', email)
            .limit(1)
            .get();

        if (!querySnapshot.empty) {
            return querySnapshot.docs[0].data().rol;
        }
          return null;
    } catch (error) {
        console.error("Error al obtener rol del usuario:", error);
        return null;
    }
}

    // Animación de carga inicial
    setTimeout(() => {
        attendanceContainer.classList.add('loaded');
    }, 100);

    // Mostrar fecha y hora actual
    function updateDateTime() {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        currentDateElement.textContent = now.toLocaleDateString('es-ES', options);
    }

    // Actualizar cada segundo
    updateDateTime();
    setInterval(updateDateTime, 1000);

    async function getUserData(email) {
        try {
            // Primero intentar con búsqueda exacta
            let querySnapshot = await db.collection('colaboradores')
                .where('CORREO ELECTRÓNICO EMPRESARIAL', '==', email)
                .limit(1)
                .get();

            // Si no se encuentra, intentar con búsqueda flexible
            if (querySnapshot.empty) {
                querySnapshot = await db.collection('colaboradores')
                    .where('CORREO ELECTRÓNICO EMPRESARIAL', '>=', email.toLowerCase())
                    .where('CORREO ELECTRÓNICO EMPRESARIAL', '<=', email.toLowerCase() + '\uf8ff')
                    .limit(1)
                    .get();
            }

            if (!querySnapshot.empty) {
                return { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
            }
            
            return null;
        } catch (error) {
            console.error("Error al obtener datos del usuario:", error);
            return null;
        }
    }

    // Función mejorada para verificar estado activo desde colaboradores
async function checkActiveAttendanceFromCollaborators(email) {
    try {
        const collaboratorQuery = await db.collection('colaboradores')
            .where('CORREO ELECTRÓNICO EMPRESARIAL', '==', email)
            .limit(1)
            .get();

        if (collaboratorQuery.empty) {
            console.log("No se encontró el colaborador con ese correo");
            return null;
        }

        const collaboratorData = collaboratorQuery.docs[0].data();
        const collaboratorId = collaboratorQuery.docs[0].id;

        // Verificar si tiene asistencia registrada hoy y estado es true
        if (collaboratorData.asistencia?.estado === true && collaboratorData.asistencia?.fecha) {
            const lastAttendanceDate = collaboratorData.asistencia.fecha.toDate();
            const today = new Date();
            
            // Comparar si la última asistencia fue hoy
            if (
                lastAttendanceDate.getDate() === today.getDate() &&
                lastAttendanceDate.getMonth() === today.getMonth() &&
                lastAttendanceDate.getFullYear() === today.getFullYear()
            ) {
                return {
                    id: collaboratorId,
                    ...collaboratorData,
                    horaRegistro: lastAttendanceDate.toLocaleTimeString('es-ES')
                };
            }
        }
        
        return null;
    } catch (error) {
        console.error("Error al verificar asistencia activa:", error);
        return null;
    }
}

    // Función para verificar si ya existe asistencia hoy
    async function checkExistingAttendance(email) {
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const attendanceRef = db.collection('asistencias');
            const query = attendanceRef.where('correoEmpresarial', '==', email)
                                    .where('fecha', '>=', firebase.firestore.Timestamp.fromDate(today))
                                    .where('fecha', '<', firebase.firestore.Timestamp.fromDate(tomorrow))
                                    .limit(1);
            
            const querySnapshot = await query.get();
            return !querySnapshot.empty;
        } catch (error) {
            console.error("Error al verificar asistencia:", error);
            return false;
        }
    }

    // Mostrar información del usuario
function displayUserInfo(user) {
    employeeDetails.innerHTML = `
        <h3>${user.NOMBRE || 'Nombre no disponible'}</h3>
        <p><strong>Área:</strong> ${user['ÁREA'] || 'No especificado'}</p>
        <p><strong>ID Empleado:</strong> ${user.NIT || 'ID no disponible'}</p>
        <p><strong>RFC:</strong> ${user.RFC || 'No disponible'}</p>
        <p><strong>Teléfono:</strong> ${user['TELÉFONO MOVIL'] || 'No disponible'}</p>
        <p><strong>Asistencia hoy:</strong> ${user.asistencia?.estado ? '<span style="color: var(--success);">Presente</span>' : '<span style="color: var(--error);">Pendiente</span>'}</p>
    `;
    
    // Si el usuario tiene imagen de perfil
    if (user.imagen) {
        employeeAvatar.src = user.imagen;
    } else {
        // Si no tiene imagen, usar iniciales
        const name = user.NOMBRE || '';
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
        employeeAvatar.src = `https://ui-avatars.com/api/?name=${initials}&background=4e54c8&color=fff&size=128`;
    }
}

    // Variable para almacenar las coordenadas
    let userCoordinates = null;
    
    // Función para obtener la ubicación
    function getLocation() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                // Agregar timeout independiente para mayor control
                const timeout = setTimeout(() => {
                    reject(new Error("Tiempo de espera agotado al obtener ubicación"));
                }, 15000); // 15 segundos

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(timeout); // Limpiar timeout cuando se resuelva
                        
                        // Verificar que la precisión sea aceptable (ej. menos de 100 metros)
                        if (position.coords.accuracy > 100) {
                            reject(new Error("La precisión de la ubicación es demasiado baja. Intenta en un área con mejor señal."));
                            return;
                        }

                        userCoordinates = {
                            latitude: Math.round(position.coords.latitude * 1000) / 1000, // Redondear para privacidad
                            longitude: Math.round(position.coords.longitude * 1000) / 1000, // Redondear para privacidad
                            accuracy: position.coords.accuracy,
                            timestamp: firebase.firestore.Timestamp.fromDate(new Date())
                        };
                        
                        // Almacenar coordenadas en sessionStorage para persistencia
                        sessionStorage.setItem('userCoordinates', JSON.stringify(userCoordinates));
                        
                        // Mostrar feedback visual de la precisión
                        updateAccuracyIndicator(position.coords.accuracy);
                        
                        resolve(userCoordinates);
                    },
                    (error) => {
                        clearTimeout(timeout); // Limpiar timeout en caso de error
                        console.error("Error al obtener ubicación:", error);
                        
                        let errorMessage = "Error desconocido";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Permiso de ubicación denegado. Por favor habilita los permisos.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "La información de ubicación no está disponible.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "La solicitud de ubicación ha caducado. Intenta nuevamente.";
                                break;
                        }
                        
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                reject(new Error("Geolocalización no soportada por el navegador"));
            }
        });
    }
    
    // Mostrar feedback visual de la precisión
    function updateAccuracyIndicator(accuracy) {
        const accuracyElement = document.getElementById('accuracyIndicator');
        if (accuracyElement) {
            accuracyElement.textContent = `Precisión: ~${Math.round(accuracy)} metros`;
            accuracyElement.style.color = accuracy < 50 ? 'green' : accuracy < 100 ? 'orange' : 'red';
        }
    }
    
    // Función fallback para cuando la geolocalización falle
    async function getFallbackLocation() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return {
                latitude: data.latitude,
                longitude: data.longitude,
                accuracy: 5000, // Baja precisión
                source: 'ip'
            };
        } catch (error) {
            return null;
        }
    }

// Función para registrar asistencia (modificada)
async function registerAttendance(attendanceType, userData) {
    try {
        const now = new Date();
        const timestamp = firebase.firestore.Timestamp.fromDate(now);
        
        // Verificar si tenemos coordenadas o intentar obtenerlas
        if (!userCoordinates) {
            try {
                const storedCoords = sessionStorage.getItem('userCoordinates');
                if (storedCoords) {
                    userCoordinates = JSON.parse(storedCoords);
                } else {
                    // Intentar obtener ubicación nuevamente
                    userCoordinates = await getLocation();
                }
            } catch (error) {
                console.warn("No se pudo obtener ubicación precisa, intentando con fallback...");
                userCoordinates = await getFallbackLocation();
            }
        }
        
        // 1. Actualizar primero el estado en colaboradores
        await db.collection('colaboradores').doc(userData.id).update({
            asistencia: {
                estado: true,
                tipo: attendanceType,
                fecha: timestamp,
            },
            ultimaAsistencia: timestamp
        });

        // 2. Luego registrar la asistencia
        const attendanceData = {
            userId: userData.id,
            email: userData['CORREO ELECTRÓNICO EMPRESARIAL'],
            nombre: userData.NOMBRE,
            area: userData['ÁREA'],
            tipo: attendanceType,
            fecha: timestamp,
            dia: now.toLocaleDateString('es-ES', { weekday: 'long' }),
            horaRegistro: now.toLocaleTimeString('es-ES'),
            activo: true,
            ubicacion: userCoordinates,
            detalles: {
                correoPersonal: userData['CORREO ELECTRONICO PERSONAL'],
                correoEmpresarial: userData['CORREO ELECTRÓNICO EMPRESARIAL'],
                rfc: userData.RFC,
                nss: userData.NSS,
                curp: userData.CURP
            }
        };

        const batch = db.batch();
        const attendanceRef = db.collection('asistencias').doc();
        batch.set(attendanceRef, attendanceData);
        await batch.commit();
        
        // Obtener el rol del usuario para redireccionamiento
        const userRole = await getUserRole(userData['CORREO ELECTRÓNICO EMPRESARIAL']);
        
        // Mostrar mensaje de éxito con ubicación aproximada
        const ubicacionMsg = attendanceType === 'office' || attendanceType === 'iztapaluca' ? 
            'Oficina verificada' : 
            'Ubicación del cliente verificada';
        
        showAlert(
            'success', 
            'Asistencia registrada', 
            `Tu asistencia ha sido registrada correctamente.<br>
            <strong>Tipo:</strong> ${getAttendanceTypeName(attendanceType)}<br>
            <strong>Ubicación:</strong> ${ubicacionMsg}<br>
            Serás redirigido en 3 segundos...`
        );
        
        // Redirigir según el rol después de 3 segundos
        setTimeout(() => {
            redirectByRole(userRole);
        }, 3000);

        return true;
    } catch (error) {
        console.error("Error al registrar asistencia:", error);
        return false;
    }
}

// Función para redireccionar según el rol (versión corregida)
function redirectByRole(role) {
    switch(role) {
        case 'puntoVenta':
            window.location.href = '../nav-puntoVenta/inicio.html';
            break;
        case 'facturas':
            window.location.href = '../nav-facturas/facturas.html';
            break;
        case 'colaborador':
            window.location.href = '../nav-operadores/gestion_Tickets.html';
            break;
        case 'admincolaborador':
            window.location.href = '../nav-mesa/gestion-tickets.html';
            break;
        default:
            window.location.href = "../nav-operadores/gestion_Tickets.html";
    }
}

// Configurar el botón de enviar con los datos del usuario (modificado)
function setupSubmitButton(userData) {
    submitBtn.addEventListener('click', async function() {
        const selectedOption = document.querySelector('.attendance-option.selected');
        
        if (!selectedOption) {
            errorAlert.classList.add('show');
            if(optionsGrid) {
                optionsGrid.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    optionsGrid.style.animation = '';
                }, 500);
            }
            return;
        }

        const attendanceType = selectedOption.getAttribute('data-value');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
        submitBtn.disabled = true;

        const success = await registerAttendance(attendanceType, userData);
        
        if (!success) {
            showAlert(
                'error', 
                'Error al registrar', 
                'Hubo un problema al registrar tu asistencia. Por favor intenta nuevamente.'
            );
            submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Registrar Asistencia';
            submitBtn.disabled = false;
        }
    });
}

    // Función auxiliar para obtener el nombre del tipo de asistencia
    function getAttendanceTypeName(type) {
        const types = {
            'office': 'En oficina',
            'site': 'En sitio',
            'iztapaluca': 'En oficina de Iztapaluca',
            'sick': 'Incapacidad'
        };
        return types[type] || type;
    }

    // Configurar el botón de ubicación
    locationBtn.addEventListener('click', async function() {
        locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo ubicación...';
        locationBtn.disabled = true;
        
        try {
            await getLocation();
            locationOverlay.classList.remove('show');
            
            // Mostrar mensaje de éxito
            showAlert(
                'success', 
                'Ubicación verificada', 
                'Gracias por activar tu ubicación. Ahora puedes registrar tu asistencia con total seguridad.'
            );
            
            // Continuar con el flujo normal de la aplicación
            initApp();
        } catch (error) {
            console.error("Error al obtener ubicación:", error);
            
            // Mostrar mensaje de error específico
            showAlert(
                'error', 
                'Ubicación requerida', 
                error.message || 'No podemos continuar sin acceso a tu ubicación. Por favor, actualiza la página e intenta nuevamente.'
            );
            
            locationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Intentar nuevamente';
            locationBtn.disabled = false;
        }
    });

    // Función para inicializar la aplicación después de obtener ubicación
    function initApp() {
        // Tu lógica de inicialización existente...
    }

    // Función para mostrar alertas
function showAlert(type, title, message) {
    // Ocultar todas las alertas primero
    alertOverlay.classList.remove('show');
    errorAlert.classList.remove('show');
    
    if (type === 'error') {
        // Configurar alerta de error
        document.querySelector('#errorAlert .alert-title').textContent = title;
        document.querySelector('#errorAlert .alert-message').innerHTML = message;
        errorAlert.classList.add('show');
    } else {
        // Configurar alerta normal (éxito/info)
        document.querySelector('#alertOverlay .alert-title').textContent = title;
        document.querySelector('#alertOverlay .alert-message').innerHTML = message;
        alertOverlay.classList.add('show');
    }
    
    // Configurar el icono según el tipo
    const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
    const iconElement = type === 'error' 
        ? document.querySelector('#errorAlert .alert-icon i') 
        : document.querySelector('#alertOverlay .alert-icon i');
    iconElement.className = `fas ${icon}`;
}

// Observador de autenticación modificado para verificar rol
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // Obtener el rol del usuario
        const userRole = await getUserRole(user.email);
        
        // Verificar si el rol está permitido (todos menos 'user' y 'admin')
        if (userRole === 'user' || userRole === 'admin') {
            showAlert('error', 'Acceso denegado', 
                     'No tienes permisos para acceder a esta función. Serás redirigido.');
            
            setTimeout(() => {
                auth.signOut().then(() => {
                    window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html";
                });
            }, 3000);
            return;
        }
        
        // Resto de la lógica existente...
        const activeAttendance = await checkActiveAttendanceFromCollaborators(user.email);
        
        if (activeAttendance) {
            displayUserInfo(activeAttendance);
            
            showAlert(
                'info', 
                '¡Asistencia ya registrada hoy!', 
                `Ya registraste tu asistencia hoy a las ${activeAttendance.horaRegistro}.<br>
                Serás redirigido al panel en 3 segundos...`
            );
            
            // Redirigir según el rol
            setTimeout(() => {
                redirectByRole(userRole);
            }, 3000);
        } else {
            const userData = await getUserData(user.email);
            
            if (!userData) {
                console.error("No se encontraron datos para el usuario");
                showAlert('error', 'Datos no encontrados', 
                         'No se encontraron datos para este usuario. Serás redirigido a la página de inicio de sesión.');
                
                setTimeout(() => {
                    auth.signOut().then(() => {
                        window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html";
                    });
                }, 3000);
                return;
            }
            
            displayUserInfo(userData);
            
            const storedCoords = sessionStorage.getItem('userCoordinates');
            if (storedCoords) {
                userCoordinates = JSON.parse(storedCoords);
            } else {
                locationOverlay.classList.add('show');
            }
            
            setupSubmitButton(userData);
        }
        } else {
        window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html";
    }
});

    // Botón de alerta
    alertBtn.addEventListener('click', function() {
        alertOverlay.classList.remove('show');
    });
    
    // Botón de alerta de error
    errorBtn.addEventListener('click', function() {
        errorAlert.classList.remove('show');
    });

    locationBtn.addEventListener('click', function() {
    locationOverlay.classList.remove('show');
});

    // Animación de shake
    const style = document.createElement('style');
    style.textContent = `
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(78, 84, 200, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // Selección de opciones de asistencia
    attendanceOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Deseleccionar todas las opciones
            attendanceOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Seleccionar la opción clickeada
            this.classList.add('selected');
        });
    });
});
    
</script>
</body>
</html>